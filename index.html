<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚³ã‚¢ãƒ©ãƒ¡ãƒ¢</title>

    <link rel="manifest" href="manifest.json?v=3">
    <meta name="theme-color" content="#2e7d32">
    <link rel="icon" href="koalaface.png">
    <link rel="apple-touch-icon" href="koalaface.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&family=Outfit:wght@400;700&display=swap"
        rel="stylesheet">

    <style>
        /* â–¼ å…¨ä½“ã®è¨­å®š */
        body {
            font-family: 'Zen Maru Gothic', 'Noto Sans JP', sans-serif;
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
            padding: 20px;
            padding-top: env(safe-area-inset-top);
        }

        h1,
        h2,
        h3,
        .koala-name,
        .birthday-title,
        .month-btn,
        .search-label,
        .badge,
        #backButton,
        p.subtitle {
            font-family: 'Zen Maru Gothic', 'Outfit', sans-serif;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: #2e7d32;
            margin: 0;
            font-size: 2.2em;
            font-weight: 700;
            cursor: pointer;
            letter-spacing: -0.02em;
        }

        p.subtitle {
            color: #888;
            font-size: 0.8em;
            margin-top: 5px;
            font-weight: 400;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        #backButton {
            display: none;
            margin: 0 auto 20px auto;
            background-color: #666;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
        }

        /* â–¼ è¡¨ç¤ºã‚¨ãƒªã‚¢åˆ¶å¾¡ */
        .view-section {
            display: none;
        }

        /* â–¼ ãŠèª•ç”Ÿæ—¥ã‚¨ãƒªã‚¢ */
        #birthdaySection {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 30px;
            border: 2px solid #ffcc80;
            text-align: center;
        }

        .birthday-title {
            text-align: center;
            color: #e65100;
            font-weight: bold;
            margin-bottom: 12px;
            font-size: 1.1em;
        }

        .month-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .month-btn {
            background-color: white;
            border: 1px solid #ffcc80;
            color: #e65100;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            cursor: pointer;
            font-weight: bold;
        }

        .month-btn.active {
            background-color: #e65100;
            color: white;
            border-color: #e65100;
        }

        .birthday-list {
            display: flex;
            overflow-x: auto;
            gap: 15px;
            padding-bottom: 5px;
            margin-bottom: 10px;
            text-align: left;
        }

        .birthday-card {
            background: white;
            padding: 10px;
            border-radius: 8px;
            min-width: 200px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-top: 4px solid #ff9800;
            flex-shrink: 0;
        }

        .toggle-dead-btn {
            background-color: transparent;
            border: 1px solid #e65100;
            color: #e65100;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.8em;
            cursor: pointer;
            margin-top: 5px;
        }

        /* â–¼ æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã‚¨ãƒªã‚¢ */
        .search-container {
            margin-bottom: 25px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .search-group {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            margin-bottom: 12px;
        }

        .search-label {
            display: block;
            font-size: 0.85em;
            font-weight: bold;
            color: #2e7d32;
            margin-bottom: 8px;
            text-align: left;
        }

        .search-inputs {
            display: flex;
            gap: 10px;
        }

        input[type="text"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #eee;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            box-sizing: border-box;
            background-color: #fafafa;
        }

        input[type="text"]:focus,
        select:focus {
            border-color: #2e7d32;
            background-color: #fff;
        }

        /* â–¼ ãƒ¡ã‚¤ãƒ³ã®ã‚³ã‚¢ãƒ©ãƒªã‚¹ãƒˆ */
        .koala-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }

        .section-title {
            grid-column: 1 / -1;
            text-align: center;
            font-weight: bold;
            color: #2e7d32;
            margin: 10px 0;
            display: none;
            font-size: 1.2em;
        }

        /* â–¼ ã‚³ã‚¢ãƒ©ã‚«ãƒ¼ãƒ‰ */
        .koala-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border-left: 5px solid #2e7d32;
            transition: transform 0.2s;
            position: relative;
        }

        .koala-card:active {
            transform: scale(0.98);
        }

        .deceased-style {
            background-color: #f0f0f0;
            opacity: 0.9;
            border-color: #ccc !important;
            color: #666;
        }

        .deceased-style .badge.age {
            background-color: #999;
        }

        .deceased-style .koala-zoo {
            background-color: #eee;
            color: #666;
        }

        .parent-hero {
            grid-column: 1 / -1;
            background-color: #e8f5e9;
            border: 2px solid #2e7d32;
        }

        .koala-header {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 8px;
        }

        .koala-name {
            font-size: 1.4em;
            font-weight: bold;
            color: #333;
        }

        .badge {
            font-size: 0.75em;
            padding: 3px 8px;
            border-radius: 12px;
            color: white;
            font-weight: normal;
        }

        .male {
            background-color: #4A90E2;
        }

        .female {
            background-color: #E24A8D;
        }

        .other {
            background-color: #999;
        }

        .age {
            background-color: #2ecc71;
        }

        .koala-zoo {
            display: inline-block;
            background-color: #e8f5e9;
            color: #2e7d32;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.9em;
            font-weight: bold;
            margin-bottom: 12px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 5px 10px;
            font-size: 0.95em;
            color: #444;
        }

        .label-icon {
            color: #888;
            width: 20px;
            text-align: center;
        }

        .memo-text {
            margin-top: 12px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 6px;
            font-size: 0.9em;
            color: #555;
            line-height: 1.5;
        }

        a.zoo-link {
            text-decoration: none;
            color: inherit;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        a.zoo-link:hover {
            opacity: 0.7;
            text-decoration: underline;
        }

        .parent-link {
            color: #2e7d32;
            text-decoration: underline;
            cursor: pointer;
            font-weight: bold;
        }

        /* â–¼ ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ */
        .card-buttons {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .family-btn {
            flex: 1;
            padding: 8px;
            background-color: #fff3e0;
            color: #e65100;
            border: 1px solid #ffcc80;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            font-size: 0.9em;
            text-decoration: none;
            box-sizing: border-box;
            min-width: 80px;
        }

        .family-btn:hover {
            background-color: #ffe0b2;
        }

        /* Instagramãƒœã‚¿ãƒ³ï¼ˆãƒ”ãƒ³ã‚¯ï¼‰ */
        .insta-btn {
            background-color: #fce4ec;
            color: #d81b60 !important;
            border: 1px solid #f8bbd0;
        }

        .insta-btn:hover {
            background-color: #f8bbd0;
        }

        /* â–¼ ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€šè¨­å®š */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            width: 95%;
            max-width: 500px;
            border-radius: 12px;
            padding: 20px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
            box-sizing: border-box;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            z-index: 10;
        }

        /* å®¶æ—ã•ã‚“ï¼ˆè¡€çµ±è¡¨ï¼‰ã‚¹ã‚¿ã‚¤ãƒ« */
        .pedigree-table {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: repeat(4, 1fr);
            gap: 4px;
            margin-top: 15px;
            border: 2px solid #2e7d32;
            background-color: #2e7d32;
        }

        .ped-cell {
            background-color: #f9f9f9;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 8px 2px;
            text-align: center;
            font-size: 0.8em;
        }

        .ped-pos-ff {
            grid-column: 1;
            grid-row: 1;
        }

        .ped-pos-fm {
            grid-column: 1;
            grid-row: 2;
        }

        .ped-pos-mf {
            grid-column: 1;
            grid-row: 3;
        }

        .ped-pos-mm {
            grid-column: 1;
            grid-row: 4;
        }

        .ped-pos-father {
            grid-column: 2;
            grid-row: 1 / 3;
        }

        .ped-pos-mother {
            grid-column: 2;
            grid-row: 3 / 5;
        }

        .ped-pos-self {
            grid-column: 3;
            grid-row: 1 / 5;
            font-size: 1.1em;
            background-color: #e8f5e9;
            font-weight: bold;
        }

        .ped-male {
            border-left: 3px solid #4A90E2;
        }

        .ped-female {
            border-left: 3px solid #E24A8D;
        }

        /* ãã‚‡ã†ã ã„ãƒªã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ« */
        .sibling-section {
            margin-top: 20px;
        }

        .sibling-title {
            font-weight: bold;
            color: #2e7d32;
            border-bottom: 2px solid #a5d6a7;
            margin-bottom: 10px;
            padding-bottom: 5px;
            font-size: 1em;
        }

        .sibling-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .sibling-item:hover {
            background-color: #f5f5f5;
        }

        .sibling-name {
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            gap: 5px;
            flex-wrap: wrap;
        }

        /* â–¼ ãƒã‚¤ãƒšãƒ¼ã‚¸ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .profile-box {
            background: white;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            border-top: 5px solid #2e7d32;
            text-align: center;
        }

        .welcome-banner {
            background-color: #e8f5e9;
            color: #2e7d32;
            padding: 15px;
            border-radius: 12px;
            margin: 0 auto 20px auto;
            max-width: 600px;
            font-weight: 700;
            text-align: center;
            font-size: 1.1em;
            display: none;
        }

        .fortune-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .fortune-card {
            background: #fdfdfd;
            padding: 10px 5px;
            border-radius: 12px;
            border: 1px solid #edf2f7;
            text-align: center;
        }

        .fortune-label {
            font-size: 0.7em;
            color: #888;
            margin-bottom: 3px;
        }

        .fortune-value {
            font-size: 0.95em;
            font-weight: 700;
            color: #2e7d32;
        }

        .partner-card-outer {
            background: linear-gradient(135deg, #f0f7ff 0%, #e0f0ff 100%);
            border-radius: 16px;
            padding: 30px;
            border: 2px solid #add8e6;
            text-align: center;
            margin-top: 30px;
            grid-column: 1 / -1;
        }

        .mypage-btn {
            display: inline-block;
            width: auto;
            background-color: #2e7d32;
            color: white;
            border: none;
            padding: 6px 14px;
            border-radius: 30px;
            font-weight: bold;
            font-size: 0.8em;
            cursor: pointer;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            white-space: nowrap;
            transition: all 0.2s;
        }

        .mypage-btn:hover {
            background-color: #256b29;
            transform: translateY(-1px);
        }

        .welcome-container {
            display: none;
            max-width: 650px;
            margin: 0 auto 25px auto;
            background-color: #e8f5e9;
            padding: 8px 16px;
            border-radius: 50px;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            border: 1px solid #c8e6c9;
        }

        .welcome-banner {
            color: #2e7d32;
            font-weight: 700;
            font-size: 0.9em;
            margin: 0;
            flex: 1;
            text-align: left;
            line-height: 1.3;
        }

        .mypage-input-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .mypage-input-label {
            display: block;
            font-size: 0.9em;
            font-weight: bold;
            color: #2e7d32;
            margin-bottom: 5px;
        }
    </style>
</head>

<body>

    <header>
        <h1 onclick="goHome()">ğŸ¨ ã‚³ã‚¢ãƒ©ãƒ¡ãƒ¢ ğŸ¨</h1>
        <p class="subtitle">Japan Koala Database</p>
    </header>

    <div id="welcomeContainer" class="welcome-container">
        <div id="welcomeBanner" class="welcome-banner"></div>
        <button class="mypage-btn" onclick="navigate('mypage')">ğŸ“› my page</button>
    </div>

    <button id="backButton" onclick="goHome()">â† TOPã«ã‚‚ã©ã‚‹</button>

    <div id="homeView" class="view-section">
        <div id="birthdaySection">
            <div class="birthday-title" id="birthdayTitle">ğŸ‰ ä»Šæœˆã®ãŠèª•ç”Ÿæ—¥ ğŸ‰</div>
            <div class="month-tabs">
                <button id="btnCurrentMonth" class="month-btn active" onclick="changeBirthdayMonth(0)">ä»Šæœˆ</button>
                <button id="btnNextMonth" class="month-btn" onclick="changeBirthdayMonth(1)">æ¥æœˆ</button>
            </div>
            <div class="birthday-list" id="birthdayList"></div>
            <div id="birthdayToggleContainer"></div>
        </div>
        <div class="search-container" id="searchContainer">
            <div class="search-group">
                <label class="search-label">ğŸ” ãªã¾ãˆã§æ¤œç´¢</label>
                <div class="search-inputs">
                    <input type="text" id="searchInput" placeholder="ä¾‹ï¼šã“ã¾ã¡ã€ãã‚‰ã‚‰..." onkeyup="filterByName()">
                </div>
            </div>
            <div class="search-group">
                <label class="search-label">ğŸ“ å‹•ç‰©åœ’ã‹ã‚‰æ¢ã™</label>
                <div class="search-inputs">
                    <select id="zooFilter" onchange="filterByZoo()">
                        <option value="">å‹•ç‰©åœ’ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                    </select>
                </div>
            </div>
        </div>
        <!-- ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆãªã©ã®äºˆå‚™ãƒœã‚¿ãƒ³ -->
        <div id="homeMyPageBtnRow" style="text-align:center; margin-bottom:20px;">
            <button class="mypage-btn" onclick="navigate('mypage')">ğŸ“› my page</button>
        </div>
    </div>

    <div id="myPageView" class="view-section">
        <h2 style="text-align:center; color:#2e7d32;">ğŸ‘¤ ãƒã‚¤ãƒšãƒ¼ã‚¸è¨­å®š</h2>
        <div class="profile-box">
            <div class="mypage-input-group">
                <label class="mypage-input-label">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </label>
                <input type="text" id="userNickname" placeholder="ä¾‹ï¼šã‚³ã‚¢ãƒ©å¤§å¥½ããƒãƒ³" onchange="saveProfile()">
            </div>
            <div class="mypage-input-group">
                <label class="mypage-input-label">ã‚ãªãŸã®ç”Ÿå¹´æœˆæ—¥</label>
                <input type="date" id="userBirthday" onchange="saveProfile()">
            </div>

            <div id="fortuneDisplay" class="fortune-grid"></div>
        </div>

        <!-- é‹å‘½ã®ã‚³ã‚¢ãƒ©ã‚’ä¸Šä½ã«è¡¨ç¤º -->
        <div id="myPagePartnerSection">
            <h3 style="text-align:center; color:#2e7d32; margin-top:40px;">ğŸ’– é‹å‘½ã®ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚³ã‚¢ãƒ©</h3>
            <div id="myPagePartnerContent" class="koala-list"></div>
        </div>

        <div id="myPageSameMonthSection">
            <h3 id="sameMonthTitle" style="text-align:center; color:#2e7d32; margin-top:40px;">ğŸ‚ ã‚ãªãŸã¨åŒã˜æœˆç”Ÿã¾ã‚Œã®ã‚³ã‚¢ãƒ©</h3>
            <div id="myPageSameMonthList" class="koala-list"></div>
        </div>
    </div>

    <div id="listView" class="view-section" style="display:block;">
        <div id="listTitle" class="section-title"></div>
        <div id="koalaList" class="koala-list">
            <div id="loadingMsg" style="text-align:center; color:#999; grid-column:1/-1;">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
        </div>
    </div>

    <div id="pedigreeModal" class="modal-overlay" onclick="closeModals()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="close-btn" onclick="closeModals()">Ã—</span>
            <h2 style="text-align:center; color:#2e7d32; margin:0;">ğŸ§¬ å®¶æ—ã•ã‚“</h2>
            <div id="pedigreeChart" class="pedigree-table"></div>
        </div>
    </div>

    <div id="siblingModal" class="modal-overlay" onclick="closeModals()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="close-btn" onclick="closeModals()">Ã—</span>
            <h2 id="siblingModalTitle" style="text-align:center; color:#2e7d32; margin:0;">ğŸ’ ãã‚‡ã†ã ã„</h2>
            <div id="siblingListContent"></div>
        </div>
    </div>

    <script>
        let koalaData = [];
        let showDeceasedBirthday = false;
        let currentBirthdayOffset = 0;

        const zooUrls = {
            "æ±å±±": "https://www.higashiyama.city.nagoya.jp/", "æ±å±±å‹•æ¤ç‰©åœ’": "https://www.higashiyama.city.nagoya.jp/",
            "å¤šæ‘©": "https://www.tokyo-zoo.net/zoo/tama/", "å¤šæ‘©å‹•ç‰©å…¬åœ’": "https://www.tokyo-zoo.net/zoo/tama/",
            "åŸ¼ç‰": "https://www.parks.or.jp/sczoo/", "åŸ¼ç‰çœŒã“ã©ã‚‚": "https://www.parks.or.jp/sczoo/", "åŸ¼ç‰çœŒã“ã©ã‚‚å‹•ç‰©è‡ªç„¶å…¬åœ’": "https://www.parks.or.jp/sczoo/",
            "å¹³å·": "https://hirakawazoo.jp/", "å¹³å·å‹•ç‰©å…¬åœ’": "https://hirakawazoo.jp/",
            "é‡‘æ²¢": "https://www.hama-midorinokyokai.or.jp/zoo/kanazawa/", "æ¨ªæµœé‡‘æ²¢": "https://www.hama-midorinokyokai.or.jp/zoo/kanazawa/", "é‡‘æ²¢å‹•ç‰©åœ’": "https://www.hama-midorinokyokai.or.jp/zoo/kanazawa/", "æ¨ªæµœå¸‚ç«‹é‡‘æ²¢å‹•ç‰©åœ’": "https://www.hama-midorinokyokai.or.jp/zoo/kanazawa/",
            "ç‹å­": "https://www.kobe-ojizoo.jp/", "ç¥æˆ¸å¸‚ç‹å­": "https://www.kobe-ojizoo.jp/", "ç¥æˆ¸å¸‚ç«‹ç‹å­å‹•ç‰©åœ’": "https://www.kobe-ojizoo.jp/",
            "æ·¡è·¯": "https://www.england-hill.com/", "ã‚¤ãƒ³ã‚°ãƒ©ãƒ³ãƒ‰ã®ä¸˜": "https://www.england-hill.com/",
            "å¤©ç‹å¯º": "https://www.tennojizoo.jp/", "å¤©ç‹å¯ºå‹•ç‰©åœ’": "https://www.tennojizoo.jp/"
        };

        // åˆæœŸåŒ–
        function loadFromSpreadsheet() {
            const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQi6GZ0pWmE1A0MSJBoSyHYaKvAHkgFeBRvZPmMHqHLBh53VzAr5nyJ43qOVuTj4y2xus5nzzurKmUX/pub?gid=107153803&single=true&output=csv";

            Papa.parse(sheetUrl, {
                download: true, header: true,
                complete: function (results) {
                    koalaData = results.data
                        .filter(item => item.name && item.name !== "")
                        .map(item => {
                            item.id = String(item.id);
                            if (item.father_id) item.father_id = String(item.father_id);
                            if (item.mother_id) item.mother_id = String(item.mother_id);
                            return item;
                        })
                        .sort((a, b) => a.id.localeCompare(b.id)); // IDã§ã‚½ãƒ¼ãƒˆã—ã¦ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã‚’å®‰å®šã•ã›ã‚‹

                    document.getElementById('loadingMsg').style.display = 'none';
                    populateZooFilter();

                    // URLã‹ã‚‰åˆæœŸçŠ¶æ…‹ã‚’æ±ºå®šã™ã‚‹
                    processUrlParams();
                },
                error: function (err) {
                    document.getElementById('loadingMsg').textContent = 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                }
            });
        }

        // â–¼ ãƒ«ãƒ¼ã‚¿ãƒ¼ (URLã‚’å”¯ä¸€ã®åŸºæº–ã«ã™ã‚‹)
        window.addEventListener('popstate', function (e) {
            processUrlParams();
        });

        function processUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const view = params.get('view') || 'list';
            const id = params.get('id');

            // å…¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            document.getElementById('pedigreeModal').style.display = 'none';
            document.getElementById('siblingModal').style.display = 'none';

            if (koalaData.length === 0) return;

            if (view === 'family' && id) {
                renderFamily(id);
            } else if (view === 'detail' && id) {
                renderDetail(id);
            } else if (view === 'mypage') {
                renderMyPage();
            } else {
                renderHome();
            }
        }

        function navigate(view, id) {
            const params = new URLSearchParams();
            if (view !== 'list') params.set('view', view);
            if (id) params.set('id', id);

            const url = params.toString() ? '?' + params.toString() : window.location.pathname;

            // å±¥æ­´ã«ç©ã‚€
            history.pushState(null, null, url);
            processUrlParams();
        }

        function goHome() {
            navigate('list');
        }

        function jumpToKoala(id) { navigate('detail', id); }
        function showFamily(id) { navigate('family', id); }

        function showPedigree(id) {
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã¯URLã‚’å¤‰ãˆãšã«è¡¨ç¤ºï¼ˆpopstateã§é–‰ã˜ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã ã‘ã«å±¥æ­´ã‚’æ±šã•ãªã„ï¼‰
            renderPedigreeModal(String(id));
        }
        function showSiblings(id) {
            renderSiblingsModal(String(id));
        }

        function closeModals() {
            document.getElementById('pedigreeModal').style.display = 'none';
            document.getElementById('siblingModal').style.display = 'none';
        }

        // æ±ºå®šè«–çš„ãªã‚·ãƒ¼ãƒ‰ã®ãŸã‚ã®CRC32é–¢æ•°
        function crc32(str) {
            let crc = 0 ^ (-1);
            for (let i = 0; i < str.length; i++) {
                let p = (crc ^ str.charCodeAt(i)) & 0xFF;
                let t = [
                    0x00000000, 0x77073096, 0xEE0E612C, 0x990951BA, 0x076DC419, 0x706AF48F, 0xE963A535, 0x9E6495A3,
                    0x0EDB8832, 0x79DCB8A4, 0xE0D5E91E, 0x97D2D988, 0x09B64C2B, 0x7EB17CBD, 0xE7B82D07, 0x90BF1D91
                ][p & 0xF] ^ [
                    0x00000000, 0x1DB71064, 0x3B6E20C8, 0x26D930AC, 0x76DC4190, 0x6B6B51F4, 0x4DB26158, 0x5005713C
                ][(p >> 4) & 0xF] ^ (crc >>> 8); // ç°¡ç•¥åŒ–ã•ã‚ŒãŸCRC
                // æ­£ç¢ºãªCRC32ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ä»£ã‚ã‚Šã«ã€ã‚·ãƒ³ãƒ—ãƒ«ãªæ“¬ä¼¼ãƒãƒƒã‚·ãƒ¥ã§ã‚‚ååˆ†
            }
            // ã‚ˆã‚Šç¢ºå®Ÿãªãƒãƒƒã‚·ãƒ¥:
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = ((hash << 5) - hash) + str.charCodeAt(i);
                hash |= 0;
            }
            return Math.abs(hash);
        }

        function seededRandom(seed) {
            const x = Math.sin(seed++) * 10000;
            return x - Math.floor(x);
        }

        // â–¼ ãƒã‚¤ãƒšãƒ¼ã‚¸ç”¨ãƒ­ã‚¸ãƒƒã‚¯ & å ã„ãƒ­ã‚¸ãƒƒã‚¯
        function saveProfile() {
            const nickname = document.getElementById('userNickname').value;
            const birthday = document.getElementById('userBirthday').value;
            localStorage.setItem('user_nickname', nickname);
            localStorage.setItem('user_birthday', birthday);
            updateWelcomeBanner();
            if (window.location.search.includes('view=mypage')) {
                renderMyPage();
            }
        }

        function loadProfile() {
            const nick = localStorage.getItem('user_nickname') || "";
            const bday = localStorage.getItem('user_birthday') || "2000-01-01";
            const nickInput = document.getElementById('userNickname');
            const bdayInput = document.getElementById('userBirthday');
            if (nickInput) nickInput.value = nick;
            if (bdayInput) bdayInput.value = bday;
            updateWelcomeBanner();
        }

        function updateWelcomeBanner() {
            const nick = localStorage.getItem('user_nickname');
            const container = document.getElementById('welcomeContainer');
            const banner = document.getElementById('welcomeBanner');
            const homeBtnRow = document.getElementById('homeMyPageBtnRow');
            const isHome = !window.location.search.includes('view=') || window.location.search.includes('view=list');

            if (!isHome) {
                if (container) container.style.display = 'none';
                if (homeBtnRow) homeBtnRow.style.display = 'none';
                return;
            }

            if (container && banner) {
                const displayName = nick ? `${nick}ã•ã‚“` : "ã‚²ã‚¹ãƒˆã•ã‚“";
                banner.textContent = `ğŸŒŸ ã‚ˆã†ã“ãã€${displayName}ï¼ä»Šæ—¥ã‚‚ã‚³ã‚¢ãƒ©ã«ç™’ã‚„ã•ã‚Œã¾ã—ã‚‡ã† ğŸ¨`;
                container.style.display = 'flex';
                if (homeBtnRow) homeBtnRow.style.display = 'none'; // é‡è¤‡é˜²æ­¢
            }
        }

        function getAstrologySign(dateStr) {
            if (!dateStr) return "ä¸æ˜";
            const date = new Date(dateStr);
            const m = date.getMonth() + 1;
            const d = date.getDate();
            if ((m == 1 && d >= 20) || (m == 2 && d <= 18)) return "æ°´ç“¶åº§";
            if ((m == 2 && d >= 19) || (m == 3 && d <= 20)) return "é­šåº§";
            if ((m == 3 && d >= 21) || (m == 4 && d <= 19)) return "ç‰¡ç¾Šåº§";
            if ((m == 4 && d >= 20) || (m == 5 && d <= 20)) return "ç‰¡ç‰›åº§";
            if ((m == 5 && d >= 21) || (m == 6 && d <= 20)) return "åŒå­åº§";
            if ((m == 6 && d >= 21) || (m == 7 && d <= 22)) return "èŸ¹åº§";
            if ((m == 7 && d >= 23) || (m == 8 && d <= 22)) return "ç…å­åº§";
            if ((m == 8 && d >= 23) || (m == 9 && d <= 22)) return "ä¹™å¥³åº§";
            if ((m == 9 && d >= 23) || (m == 10 && d <= 22)) return "å¤©ç§¤åº§";
            if ((m == 10 && d >= 23) || (m == 11 && d <= 21)) return "è åº§";
            if ((m == 11 && d >= 22) || (m == 12 && d <= 21)) return "å°„æ‰‹åº§";
            return "å±±ç¾Šåº§";
        }

        function getNumerology(dateStr) {
            if (!dateStr) return 0;
            let s = dateStr.replace(/-/g, "");
            while (s.length > 1) {
                s = String([...s].reduce((acc, d) => acc + parseInt(d), 0));
            }
            return parseInt(s);
        }

        function getNineStarKi(dateStr) {
            if (!dateStr) return "ä¸æ˜";
            const year = new Date(dateStr).getFullYear();
            const stars = ["ä¸€ç™½æ°´æ˜Ÿ", "äºŒé»’åœŸæ˜Ÿ", "ä¸‰ç¢§æœ¨æ˜Ÿ", "å››ç·‘æœ¨æ˜Ÿ", "äº”é»„åœŸæ˜Ÿ", "å…­ç™½é‡‘æ˜Ÿ", "ä¸ƒèµ¤é‡‘æ˜Ÿ", "å…«ç™½åœŸæ˜Ÿ", "ä¹ç´«ç«æ˜Ÿ"];
            let s = String(year);
            const sumDigits = (n) => String(n).split('').reduce((a, b) => a + parseInt(b), 0);
            let sum = sumDigits(s);
            while (sum > 9) sum = sumDigits(sum);
            let idx = (12 - sum) % 9;
            if (idx === 0) idx = 9;
            return stars[idx - 1];
        }

        function getAnimalZodiac(dateStr) {
            if (!dateStr) return "ä¸æ˜";
            const year = new Date(dateStr).getFullYear();
            const zodiacs = ["å­ï¼ˆã­ï¼‰", "ä¸‘ï¼ˆã†ã—ï¼‰", "å¯…ï¼ˆã¨ã‚‰ï¼‰", "å¯ï¼ˆã†ï¼‰", "è¾°ï¼ˆãŸã¤ï¼‰", "å·³ï¼ˆã¿ï¼‰", "åˆï¼ˆã†ã¾ï¼‰", "æœªï¼ˆã²ã¤ã˜ï¼‰", "ç”³ï¼ˆã•ã‚‹ï¼‰", "é…‰ï¼ˆã¨ã‚Šï¼‰", "æˆŒï¼ˆã„ã¬ï¼‰", "äº¥ï¼ˆã„ã®ã—ã—ï¼‰"];
            return zodiacs[(year - 4) % 12];
        }

        function calculateCompatibility(u, k) {
            let score = 0;
            if (!k.birthday || k.birthday === "-") return 0;

            // Koala birthday parsing (YYYY-MM-DD or YYYY/MM/DD)
            const kDate = k.birthday.replace(/\//g, "-");
            const kf = {
                astrology: getAstrologySign(kDate),
                numerology: getNumerology(kDate),
                nineStar: getNineStarKi(kDate),
                animal: getAnimalZodiac(kDate)
            };

            if (u.astrology === kf.astrology) score += 40;
            if (u.numerology === kf.numerology) score += 30;
            if (u.nineStar === kf.nineStar) score += 20;
            if (u.animal === kf.animal) score += 10;
            return score;
        }

        function renderMyPage() {
            document.getElementById('homeView').style.display = 'none';
            const welcomeContainer = document.getElementById('welcomeContainer');
            if (welcomeContainer) welcomeContainer.style.display = 'none';
            document.getElementById('listView').style.display = 'none';
            document.getElementById('myPageView').style.display = 'block';
            document.getElementById('backButton').style.display = 'block';

            const bday = localStorage.getItem('user_birthday') || "2000-01-01";
            const uFortune = {
                astrology: getAstrologySign(bday),
                numerology: getNumerology(bday),
                nineStar: getNineStarKi(bday),
                animal: getAnimalZodiac(bday)
            };

            document.getElementById('fortuneDisplay').innerHTML = `
                <div class="fortune-card">
                    <div class="fortune-label">âœ¨ è¥¿æ´‹å æ˜Ÿè¡“</div>
                    <div class="fortune-value">${uFortune.astrology}</div>
                </div>
                <div class="fortune-card">
                    <div class="fortune-label">ğŸ”¢ æ•°ç§˜è¡“ (Life Path)</div>
                    <div class="fortune-value">${uFortune.numerology}</div>
                </div>
                <div class="fortune-card">
                    <div class="fortune-label">â˜¯ï¸ ä¹æ˜Ÿæ°—å­¦</div>
                    <div class="fortune-value">${uFortune.nineStar}</div>
                </div>
                <div class="fortune-card">
                    <div class="fortune-label">ğŸ¾ å‹•ç‰©å ã„ (å¹²æ”¯)</div>
                    <div class="fortune-value">${uFortune.animal}</div>
                </div>
            `;

            // Same Month Koalas
            const userMonth = new Date(bday).getMonth() + 1;
            document.getElementById('sameMonthTitle').textContent = `ğŸ‚ ã‚ãªãŸã¨åŒã˜ ${userMonth}æœˆç”Ÿã¾ã‚Œã®ã‚³ã‚¢ãƒ©`;
            const sameMonthList = document.getElementById('myPageSameMonthList');
            sameMonthList.innerHTML = '';
            const sameMonthKs = koalaData.filter(k => {
                const p = k.birthday?.split(/[-/]/);
                return p && parseInt(p[1]) === userMonth;
            }).slice(0, 6);
            sameMonthKs.forEach(k => renderCard(k, sameMonthList));

            // Partner Koala
            const partnerContent = document.getElementById('myPagePartnerContent');
            partnerContent.innerHTML = '<div style="text-align:center; grid-column:1/-1;">ç›¸æ€§è¨ºæ–­ä¸­...</div>';

            setTimeout(() => {
                const living = koalaData.filter(k => !checkIsDead(k));
                let topPartner = null;
                let topScore = -1;

                living.forEach(k => {
                    const s = calculateCompatibility(uFortune, k);
                    if (s > topScore) {
                        topScore = s;
                        topPartner = k;
                    }
                });

                partnerContent.innerHTML = '';
                if (topPartner) {
                    const outer = document.createElement('div');
                    outer.className = 'partner-card-outer';
                    outer.innerHTML = `
                        <h4 style="margin-top:0;">ğŸŠ æœ€é«˜ã®ç›¸æ€§: ${topScore}ç‚¹ï¼</h4>
                        <p>ã‚ãªãŸã¨æœ€ã‚‚æ°—ãŒåˆã†ã‚³ã‚¢ãƒ©ã¯ <strong>${topPartner.name}</strong> ã§ã™ï¼</p>
                    `;
                    partnerContent.appendChild(outer);
                    renderCard(topPartner, outer, true);
                } else {
                    partnerContent.innerHTML = '<p style="text-align:center; grid-column:1/-1;">ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼å€™è£œãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>';
                }
            }, 500);

            window.scrollTo(0, 0);
        }

        // â–¼ æç”»ãƒ­ã‚¸ãƒƒã‚¯
        function renderHome() {
            document.getElementById('homeView').style.display = 'block';
            document.getElementById('listView').style.display = 'block';
            document.getElementById('myPageView').style.display = 'none';
            document.getElementById('backButton').style.display = 'none';

            loadProfile();

            const list = document.getElementById('koalaList');
            const title = document.getElementById('listTitle');
            list.innerHTML = '';

            const searchText = document.getElementById('searchInput').value;
            const zooFilter = document.getElementById('zooFilter').value;

            if (searchText) {
                filterByName();
            } else if (zooFilter) {
                filterByZoo();
            } else {
                title.style.display = 'block';
                title.textContent = 'ğŸŒ¿ ä»Šæ—¥ã®ãŠã™ã™ã‚ã‚³ã‚¢ãƒ© ğŸŒ¿';
                showBirthdayKoalas();
                showRandomKoalas(3);
            }
        }

        function renderDetail(id) {
            const target = koalaData.find(k => k.id === id);
            if (!target) { goHome(); return; }

            document.getElementById('homeView').style.display = 'none';
            const welcomeContainer = document.getElementById('welcomeContainer');
            if (welcomeContainer) welcomeContainer.style.display = 'none';
            document.getElementById('listView').style.display = 'block';
            document.getElementById('backButton').style.display = 'block';

            const list = document.getElementById('koalaList');
            const title = document.getElementById('listTitle');
            list.innerHTML = '';
            title.style.display = 'none';

            renderCard(target, list, true);
            window.scrollTo(0, 0);
        }

        function renderFamily(id) {
            const parent = koalaData.find(k => k.id === id);
            if (!parent) { goHome(); return; }

            document.getElementById('homeView').style.display = 'none';
            const welcomeContainer = document.getElementById('welcomeContainer');
            if (welcomeContainer) welcomeContainer.style.display = 'none';
            document.getElementById('listView').style.display = 'block';
            document.getElementById('backButton').style.display = 'block';

            const list = document.getElementById('koalaList');
            const title = document.getElementById('listTitle');
            list.innerHTML = '';

            let children = koalaData.filter(k => k.mother_id === id || k.father_id === id);
            title.style.display = 'block';
            title.innerHTML = `ğŸ¥° ${parent.name} ã®å®¶ç³» (ã“ã©ã‚‚ ${children.length}é ­)`;
            list.appendChild(title);

            renderCard(parent, list, true);

            if (children.length > 0) {
                children.sort((a, b) => new Date(a.birthday) - new Date(b.birthday));
                children.forEach(child => renderCard(child, list));
            } else {
                list.innerHTML += '<p style="text-align:center;color:#999;">è¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹å­ä¾›ã¯ã„ã¾ã›ã‚“</p>';
            }
            window.scrollTo(0, 0);
        }

        // â–¼ ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ
        function renderCard(koala, container, isHero = false) {
            const div = document.createElement('div');
            div.className = `koala-card ${checkIsDead(koala) ? 'deceased-style' : ''} ${isHero ? 'parent-hero' : ''}`;

            let genderClass = 'other';
            if (koala.gender?.includes('ã‚ªã‚¹')) genderClass = 'male';
            if (koala.gender?.includes('ãƒ¡ã‚¹')) genderClass = 'female';

            let zooDisplay = `ğŸ“ ${koala.zoo}`;
            if (zooUrls[koala.zoo]) {
                zooDisplay = `<a href="${zooUrls[koala.zoo]}" target="_blank" class="zoo-link" onclick="event.stopPropagation()">ğŸ“ ${koala.zoo} ğŸ”—</a>`;
            }

            const createLink = (id, name) => id
                ? `<span class="parent-link" onclick="event.stopPropagation(); jumpToKoala('${id}')">${name}</span>`
                : (name || "-");

            const fatherLink = createLink(koala.father_id, koala.father);
            const motherLink = createLink(koala.mother_id, koala.mother);

            const instaUrl = `https://www.instagram.com/explore/tags/${encodeURIComponent(koala.name)}/`;

            const buttons = koala.id ? `
            <div class="card-buttons">
                <button class="family-btn" onclick="event.stopPropagation(); showPedigree('${koala.id}')">ğŸ§¬ å®¶æ—ã•ã‚“</button>
                <button class="family-btn" onclick="event.stopPropagation(); showSiblings('${koala.id}')">ğŸ’ ãã‚‡ã†ã ã„</button>
                <button class="family-btn" onclick="event.stopPropagation(); showFamily('${koala.id}')">ğŸ¥° ã“ã©ã‚‚</button>
                <a href="${instaUrl}" target="_blank" class="family-btn insta-btn" onclick="event.stopPropagation()">ğŸ“· Insta</a>
            </div>
        ` : '';

            div.innerHTML = `
            <div class="koala-header">
                <div class="koala-name">${checkIsDead(koala) ? 'ğŸŒˆ ' : ''}${koala.name}</div>
                <span class="badge ${genderClass}">${koala.gender || "ä¸æ˜"}</span>
                <span class="badge age">${koala.age || "-"}</span>
            </div>
            <div class="koala-zoo">${zooDisplay}</div>
            <div class="detail-grid">
                <span class="label-icon">ğŸ‚</span> <span>${koala.birthday}</span>
                <span class="label-icon">ğŸ’™</span> <span>çˆ¶ï¼š${fatherLink}</span>
                <span class="label-icon">ğŸ§¡</span> <span>æ¯ï¼š${motherLink}</span>
            </div>
            ${koala.memo ? `<div class="memo-text">${koala.memo}</div>` : ''}
            ${buttons}
        `;
            container.appendChild(div);
        }

        // â–¼ ãƒ¢ãƒ¼ãƒ€ãƒ«ä¸­èº«
        function renderPedigreeModal(id) {
            const self = koalaData.find(k => k.id === id);
            if (!self) return;
            const getK = i => koalaData.find(k => k.id === i);
            const f = getK(self.father_id), m = getK(self.mother_id);
            const ff = f ? getK(f.father_id) : null, fm = f ? getK(f.mother_id) : null;
            const mf = m ? getK(m.father_id) : null, mm = m ? getK(m.mother_id) : null;
            const getName = (k) => k ? k.name : "ä¸æ˜";
            const getStyle = (k) => k ? (k.gender === 'ã‚ªã‚¹' ? 'ped-male' : 'ped-female') : '';

            document.getElementById('pedigreeChart').innerHTML = `
            <div class="ped-cell ped-pos-self ${getStyle(self)}">${self.name}</div>
            <div class="ped-cell ped-pos-father ${getStyle(f)}">${getName(f)}</div>
            <div class="ped-cell ped-pos-mother ${getStyle(m)}">${getName(m)}</div>
            <div class="ped-cell ped-pos-ff ${getStyle(ff)}">${getName(ff)}</div>
            <div class="ped-cell ped-pos-fm ${getStyle(fm)}">${getName(fm)}</div>
            <div class="ped-cell ped-pos-mf ${getStyle(mf)}">${getName(mf)}</div>
            <div class="ped-cell ped-pos-mm ${getStyle(mm)}">${getName(mm)}</div>
        `;
            document.getElementById('pedigreeModal').style.display = 'flex';
        }

        function renderSiblingsModal(id) {
            const self = koalaData.find(k => k.id === id);
            if (!self) return;
            document.getElementById('siblingModalTitle').textContent = `ğŸ’ ${self.name} ã®ãã‚‡ã†ã ã„`;
            const content = document.getElementById('siblingListContent');
            content.innerHTML = '';

            const isValid = n => n && !n.includes("ä¸æ˜") && !n.includes("æœªç™»éŒ²");
            const hasF = self.father_id && isValid(self.father);
            const hasM = self.mother_id && isValid(self.mother);
            const sibs = koalaData.filter(k => k.id !== id);

            if (!hasF && !hasM) {
                content.innerHTML = '<p style="text-align:center;color:#999;margin-top:20px;">ä¸¡è¦ªã®æƒ…å ±ãŒãªã„ãŸã‚è¡¨ç¤ºã§ãã¾ã›ã‚“</p>';
            } else {
                const full = sibs.filter(k => k.father_id === self.father_id && k.mother_id === self.mother_id && hasF && hasM);
                const mat = sibs.filter(k => k.mother_id === self.mother_id && k.father_id !== self.father_id && hasM);
                const pat = sibs.filter(k => k.father_id === self.father_id && k.mother_id !== self.mother_id && hasF);

                if (full.length) renderSibList(content, `ğŸ’– å…¨ãã‚‡ã†ã ã„ (${self.father}&${self.mother})`, full);
                if (hasM) renderSibList(content, `ğŸ§¡ ãŠæ¯ã•ã‚“ (${self.mother})`, mat, "è¨˜éŒ²ãªã—", 'father');
                if (hasF) renderSibList(content, `ğŸ’™ ãŠçˆ¶ã•ã‚“ (${self.father})`, pat, "è¨˜éŒ²ãªã—", 'mother');
            }
            document.getElementById('siblingModal').style.display = 'flex';
        }

        function renderSibList(container, title, list, emptyMsg, subKey) {
            const section = document.createElement('div');
            section.className = 'sibling-section';
            section.innerHTML = `<div class="sibling-title">${title}</div>`;
            if (!list.length) {
                section.innerHTML += `<p style="color:#999;font-size:0.85em;padding:5px;">${emptyMsg}</p>`;
            } else {
                list.sort((a, b) => new Date(a.birthday) - new Date(b.birthday));
                list.forEach(k => {
                    let sub = "";
                    if (subKey === 'father' && k.father) sub = `<span style="color:#999;font-size:0.85em;margin-left:5px;">(çˆ¶ï¼š${k.father})</span>`;
                    if (subKey === 'mother' && k.mother) sub = `<span style="color:#999;font-size:0.85em;margin-left:5px;">(æ¯ï¼š${k.mother})</span>`;

                    const row = document.createElement('div');
                    row.className = 'sibling-item';
                    row.onclick = (e) => { e.stopPropagation(); jumpToKoala(k.id); };
                    row.innerHTML = `
                    <div class="sibling-name">
                        <span style="color:${k.gender.includes('ã‚ªã‚¹') ? '#4A90E2' : '#E24A8D'}">â—</span>
                        ${k.name} ${checkIsDead(k) ? 'ğŸŒˆ' : ''} ${sub}
                    </div>
                    <div style="font-size:0.85em;color:#e65100;">${k.birthday || '-'}</div>
                `;
                    section.appendChild(row);
                });
            }
            container.appendChild(section);
        }

        // â–¼ ãƒ•ã‚£ãƒ«ã‚¿
        function checkIsDead(k) { return (k.death && k.death !== "") || (k.age === "æ²¡å¹´é½¢ä¸æ˜"); }

        function populateZooFilter() {
            const zoos = [...new Set(koalaData.map(k => k.zoo).filter(z => z))].sort();
            const sel = document.getElementById('zooFilter');
            sel.innerHTML = '<option value="">å‹•ç‰©åœ’ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
            zoos.forEach(z => {
                const opt = document.createElement('option');
                opt.value = z; opt.textContent = z;
                sel.appendChild(opt);
            });
        }

        // â˜…ä¿®æ­£ç‚¹ï¼šãƒ¡ãƒ¢ãŒnullã§ã‚‚ã‚¨ãƒ©ãƒ¼ã«ãªã‚‰ãªã„ã‚ˆã†ã«ä¿®æ­£
        function filterByName() {
            const text = document.getElementById('searchInput').value.toLowerCase();
            document.getElementById('zooFilter').value = "";
            document.getElementById('homeView').style.display = 'block';
            document.getElementById('listView').style.display = 'block';
            document.getElementById('backButton').style.display = 'none';

            if (!text) {
                document.getElementById('listTitle').textContent = 'ğŸŒ¿ ä»Šæ—¥ã®ãŠã™ã™ã‚ã‚³ã‚¢ãƒ© ğŸŒ¿';
                showRandomKoalas(3);
                return;
            }
            document.getElementById('listTitle').style.display = 'block';
            document.getElementById('listTitle').textContent = `ğŸ” ã€Œ${text}ã€ã®æ¤œç´¢çµæœ`;

            const filtered = koalaData.filter(k => (k.name + (k.memo || "")).toLowerCase().includes(text));
            renderListContent(filtered);
        }

        function filterByZoo() {
            const zoo = document.getElementById('zooFilter').value;
            document.getElementById('searchInput').value = "";
            document.getElementById('homeView').style.display = 'block';
            document.getElementById('listView').style.display = 'block';
            document.getElementById('backButton').style.display = 'none';

            if (!zoo) {
                document.getElementById('listTitle').textContent = 'ğŸŒ¿ ä»Šæ—¥ã®ãŠã™ã™ã‚ã‚³ã‚¢ãƒ© ğŸŒ¿';
                showRandomKoalas(3);
                return;
            }
            document.getElementById('listTitle').style.display = 'block';
            const filtered = koalaData.filter(k => k.zoo === zoo);
            document.getElementById('listTitle').textContent = `ğŸ“ ${zoo}ï¼ˆ${filtered.length}é ­ï¼‰`;
            renderListContent(filtered);
        }

        function renderListContent(listData) {
            const list = document.getElementById('koalaList');
            list.innerHTML = '';
            listData.sort((a, b) => {
                const d1 = checkIsDead(a), d2 = checkIsDead(b);
                return d1 === d2 ? 0 : d1 ? 1 : -1;
            }).forEach(k => renderCard(k, list));
        }

        function showRandomKoalas(count) {
            const liv = koalaData.filter(k => !checkIsDead(k));
            const dead = koalaData.filter(k => checkIsDead(k));

            // æ™‚é–“ãƒ™ãƒ¼ã‚¹ã®ã‚·ãƒ¼ãƒ‰ç”Ÿæˆ (YYYY-MM-DD-AM/PM)
            const now = new Date();
            const ampm = now.getHours() < 12 ? "AM" : "PM";
            const dateStr = now.toISOString().split('T')[0] + "-" + ampm;
            let seed = crc32(dateStr);

            const getSeededSample = (arr, n, s) => {
                let result = [];
                let tempArr = [...arr];
                for (let i = 0; i < n && tempArr.length > 0; i++) {
                    let r = seededRandom(s + i);
                    let idx = Math.floor(r * tempArr.length);
                    result.push(tempArr.splice(idx, 1)[0]);
                }
                return result;
            };

            let sel = [];
            sel.push(...getSeededSample(liv, 2, seed));
            if (dead.length) {
                sel.push(...getSeededSample(dead, 1, seed + 999));
            } else if (liv.length > 2) {
                // ç”Ÿãã¦ã„ã‚‹å­ãŒ3é ­ä»¥ä¸Šã„ã‚Œã°è£œå……
                const remaining = liv.filter(k => !sel.includes(k));
                sel.push(...getSeededSample(remaining, 1, seed + 888));
            }

            renderListContent(sel);
        }

        function showBirthdayKoalas() {
            const m = new Date(new Date().getFullYear(), new Date().getMonth() + currentBirthdayOffset, 1).getMonth() + 1;
            document.getElementById('btnCurrentMonth').className = currentBirthdayOffset === 0 ? 'month-btn active' : 'month-btn';
            document.getElementById('btnNextMonth').className = currentBirthdayOffset === 1 ? 'month-btn active' : 'month-btn';
            document.getElementById('birthdayTitle').textContent = currentBirthdayOffset === 0 ? `ğŸ‰ ä»Šæœˆï¼ˆ${m}æœˆï¼‰ã®ãŠèª•ç”Ÿæ—¥ ğŸ‰` : `ğŸ ã‚‚ã†ã™ãï¼ˆ${m}æœˆï¼‰ãŠèª•ç”Ÿæ—¥ ğŸ`;

            const list = document.getElementById('birthdayList');
            list.innerHTML = '';

            const birthdays = koalaData.filter(k => {
                const p = k.birthday?.split(/[-/]/);
                return p && parseInt(p[1]) === m;
            });
            const display = showDeceasedBirthday ? birthdays : birthdays.filter(k => !checkIsDead(k));

            if (!display.length) {
                list.innerHTML = `<p style="font-size:0.9em;color:#888;width:100%;text-align:center;">è©²å½“ã™ã‚‹ã‚³ã‚¢ãƒ©ã¯ã„ã¾ã›ã‚“</p>`;
            } else {
                display.forEach(k => {
                    const div = document.createElement('div');
                    div.className = `birthday-card ${checkIsDead(k) ? 'deceased-style' : ''}`;
                    div.onclick = (e) => { e.stopPropagation(); jumpToKoala(k.id); };
                    div.innerHTML = `<div style="font-weight:bold;">${k.name}${checkIsDead(k) ? ' (ğŸŒˆ)' : ''}</div><div style="font-size:0.8em;color:#666;">${k.zoo}</div><div style="color:#e65100;">ğŸ‚ ${k.birthday}</div>`;
                    list.appendChild(div);
                });
            }
            const deadCount = birthdays.filter(k => checkIsDead(k)).length;
            const cont = document.getElementById('birthdayToggleContainer');
            cont.innerHTML = '';
            if (deadCount > 0) {
                const btn = document.createElement('button');
                btn.className = 'toggle-dead-btn';
                btn.textContent = showDeceasedBirthday ? 'âœ• å…ƒæ°—ãªå­ã®ã¿è¡¨ç¤º' : `ğŸŒˆ è™¹ã®ã‚€ã“ã†ã®å­ï¼ˆ${deadCount}é ­ï¼‰ã‚‚è¡¨ç¤º`;
                btn.onclick = () => { showDeceasedBirthday = !showDeceasedBirthday; showBirthdayKoalas(); };
                cont.appendChild(btn);
            }
        }

        function changeBirthdayMonth(o) { currentBirthdayOffset = o; showBirthdayKoalas(); }

        if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(() => { });
        window.addEventListener('load', () => {
            loadFromSpreadsheet();
            loadProfile();
        });
    </script>
</body>

</html>