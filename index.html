<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚³ã‚¢ãƒ©ãƒ¡ãƒ¢</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2e7d32">
    <link rel="apple-touch-icon" href="koalaface.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        /* â–¼ å…¨ä½“ã®è¨­å®š */
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
            padding: 20px;
            padding-top: env(safe-area-inset-top);
        }

        header {
            text-align: center;
            margin-bottom: 20px;
        }

        h1 {
            color: #2e7d32;
            margin: 0;
            font-size: 1.8em;
        }
        
        p.subtitle {
            color: #666;
            font-size: 0.8em;
            margin-top: 5px;
        }

        /* â–¼ ä»Šæœˆã®ãŠèª•ç”Ÿæ—¥ã‚¨ãƒªã‚¢ */
        #birthdaySection {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 30px;
            display: none;
            border: 2px solid #ffcc80;
        }

        .birthday-title {
            text-align: center;
            color: #e65100;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .birthday-list {
            display: flex;
            overflow-x: auto;
            gap: 15px;
            padding-bottom: 5px;
        }

        .birthday-card {
            background: white;
            padding: 10px;
            border-radius: 8px;
            min-width: 200px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-top: 4px solid #ff9800;
            flex-shrink: 0;
        }

        /* â–¼ å¤©å›½ã®å­ç”¨ãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆã†ã£ã™ã‚‰ç°è‰²ï¼‰ */
        .deceased-style {
            background-color: #f0f0f0; /* èƒŒæ™¯ã‚’è–„ã„ã‚°ãƒ¬ãƒ¼ã« */
            opacity: 0.9;              /* å°‘ã—ã ã‘è–„ãã™ã‚‹ */
            border-color: #ccc !important; /* ãƒœãƒ¼ãƒ€ãƒ¼è‰²ã‚‚æ§ãˆã‚ã« */
            color: #666;               /* æ–‡å­—è‰²ã‚‚å°‘ã—è–„ã */
        }
        .deceased-style .badge.age {
            background-color: #999;    /* å¹´é½¢ãƒãƒƒã‚¸ã‚‚ã‚°ãƒ¬ãƒ¼ã« */
        }
        .deceased-style .koala-zoo {
            background-color: #eee;    /* å‹•ç‰©åœ’ãƒãƒƒã‚¸ã‚‚ã‚°ãƒ¬ãƒ¼ç³»ã« */
            color: #666;
        }

        /* â–¼ æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã‚¨ãƒªã‚¢ */
        .search-container {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 25px;
            text-align: center;
        }

        .search-inputs {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        input[type="text"] {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            flex: 1;
            min-width: 200px;
        }
        input[type="text"]:focus {
            border-color: #2e7d32;
        }

        select {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            background-color: white;
            outline: none;
            cursor: pointer;
        }

        /* â–¼ ãƒ¡ã‚¤ãƒ³ã®ã‚³ã‚¢ãƒ©ãƒªã‚¹ãƒˆ */
        .koala-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }
        
        /* ãŠã™ã™ã‚è¦‹å‡ºã— */
        .recommend-title {
            grid-column: 1 / -1;
            text-align: center;
            font-weight: bold;
            color: #2e7d32;
            margin-bottom: 10px;
            display: none; /* åˆæœŸã¯éš ã™ */
        }

        .koala-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border-left: 5px solid #2e7d32;
            transition: transform 0.2s;
        }
        .koala-card:active { transform: scale(0.98); }

        .koala-header {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 8px;
        }

        .koala-name {
            font-size: 1.4em;
            font-weight: bold;
            color: #333;
        }

        .badge {
            font-size: 0.75em;
            padding: 3px 8px;
            border-radius: 12px;
            color: white;
            font-weight: normal;
        }
        .male { background-color: #4A90E2; }
        .female { background-color: #E24A8D; }
        .other { background-color: #999; }
        .age { background-color: #2ecc71; }

        .koala-zoo {
            display: inline-block;
            background-color: #e8f5e9;
            color: #2e7d32;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.9em;
            font-weight: bold;
            margin-bottom: 12px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 5px 10px;
            font-size: 0.95em;
            color: #444;
        }
        
        .label-icon { color: #888; width: 20px; text-align: center; }

        .memo-text {
            margin-top: 12px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 6px;
            font-size: 0.9em;
            color: #555;
            line-height: 1.5;
        }

        /* ãƒªãƒ³ã‚¯ç”¨ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        a.zoo-link {
            text-decoration: none;
            color: inherit;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: opacity 0.2s;
        }
        a.zoo-link:hover {
            opacity: 0.7;
            text-decoration: underline;
        }
        .link-icon {
            font-size: 0.8em;
        }
    </style>
</head>
<body>

<header>
    <h1>ğŸ¨ ã‚³ã‚¢ãƒ©ãƒ¡ãƒ¢ ğŸ¨</h1>
    <p class="subtitle">Japan Koala Database</p>
</header>

<div id="birthdaySection">
    <div class="birthday-title" id="birthdayTitle">ğŸ‰ ä»Šæœˆï¼ˆXæœˆï¼‰ã®ãŠèª•ç”Ÿæ—¥ ğŸ‰</div>
    <div class="birthday-list" id="birthdayList">
        </div>
</div>

<div class="search-container">
    <div class="search-inputs">
        <input type="text" id="searchInput" placeholder="åå‰ã§æ¤œç´¢..." onkeyup="filterKoalas()">
        
        <select id="zooFilter" onchange="filterKoalas()">
            <option value="">å…¨ã¦ã®å‹•ç‰©åœ’</option>
        </select>
    </div>
</div>

<div id="koalaList" class="koala-list">
    <div id="recommendTitle" class="recommend-title">âœ¨ ä»Šæ—¥ã®ãŠã™ã™ã‚ã‚³ã‚¢ãƒ© âœ¨</div>
    <div id="loadingMsg" style="text-align:center; color:#999; grid-column:1/-1;">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
</div>

<script>
    let koalaData = [];

    // â–¼ å‹•ç‰©åœ’URLãƒªã‚¹ãƒˆï¼ˆè¡¨è¨˜ã‚†ã‚Œå¯¾å¿œç‰ˆï¼‰
    const zooUrls = {
        "æ±å±±": "https://www.higashiyama.city.nagoya.jp/",
        "æ±å±±å‹•æ¤ç‰©åœ’": "https://www.higashiyama.city.nagoya.jp/",
        "åå¤å±‹å¸‚æ±å±±å‹•æ¤ç‰©åœ’": "https://www.higashiyama.city.nagoya.jp/",
        "å¤šæ‘©": "https://www.tokyo-zoo.net/zoo/tama/",
        "å¤šæ‘©å‹•ç‰©å…¬åœ’": "https://www.tokyo-zoo.net/zoo/tama/",
        "åŸ¼ç‰": "https://www.parks.or.jp/sczoo/",
        "åŸ¼ç‰çœŒã“ã©ã‚‚": "https://www.parks.or.jp/sczoo/",
        "åŸ¼ç‰çœŒã“ã©ã‚‚å‹•ç‰©è‡ªç„¶å…¬åœ’": "https://www.parks.or.jp/sczoo/",
        "å¹³å·": "https://hirakawazoo.jp/",
        "å¹³å·å‹•ç‰©å…¬åœ’": "https://hirakawazoo.jp/",
        "é¹¿å…å³¶å¸‚å¹³å·å‹•ç‰©å…¬åœ’": "https://hirakawazoo.jp/",
        "é‡‘æ²¢": "https://www.hama-midorinokyokai.or.jp/zoo/kanazawa/",
        "æ¨ªæµœé‡‘æ²¢": "https://www.hama-midorinokyokai.or.jp/zoo/kanazawa/",
        "é‡‘æ²¢å‹•ç‰©åœ’": "https://www.hama-midorinokyokai.or.jp/zoo/kanazawa/",
        "æ¨ªæµœå¸‚ç«‹é‡‘æ²¢å‹•ç‰©åœ’": "https://www.hama-midorinokyokai.or.jp/zoo/kanazawa/",
        "ç‹å­": "https://www.kobe-ojizoo.jp/",
        "ç¥æˆ¸å¸‚ç‹å­": "https://www.kobe-ojizoo.jp/",
        "ç¥æˆ¸å¸‚ç«‹ç‹å­å‹•ç‰©åœ’": "https://www.kobe-ojizoo.jp/",
        "æ·¡è·¯": "https://www.england-hill.com/",
        "ã‚¤ãƒ³ã‚°ãƒ©ãƒ³ãƒ‰ã®ä¸˜": "https://www.england-hill.com/",
        "æ·¡è·¯ãƒ•ã‚¡ãƒ¼ãƒ ãƒ‘ãƒ¼ã‚¯": "https://www.england-hill.com/",
        "å¤©ç‹å¯º": "https://www.tennojizoo.jp/",
        "å¤©ç‹å¯ºå‹•ç‰©åœ’": "https://www.tennojizoo.jp/"
    };

    function loadFromSpreadsheet() {
        // â˜… å‰å›ã®URLã‚’å…¥ã‚Œã¦ãŠãã¾ã—ãŸï¼
        const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQi6GZ0pWmE1A0MSJBoSyHYaKvAHkgFeBRvZPmMHqHLBh53VzAr5nyJ43qOVuTj4y2xus5nzzurKmUX/pub?gid=107153803&single=true&output=csv";

        Papa.parse(sheetUrl, {
            download: true,
            header: true,
            complete: function(results) {
                koalaData = results.data;
                // åå‰ãŒãªã„è¡Œã‚’é™¤å¤–
                koalaData = koalaData.filter(item => item.name && item.name !== "");

                console.log("èª­ã¿è¾¼ã¿å®Œäº†:", koalaData);
                
                document.getElementById('loadingMsg').style.display = 'none';

                populateZooFilter();
                showBirthdayKoalas();
                
                // â˜… åˆæœŸè¡¨ç¤ºã¯ã€ŒãŠã™ã™ã‚ã®3é ­ã€ã‚’ãƒ©ãƒ³ãƒ€ãƒ è¡¨ç¤º
                showRandomKoalas(3);
            },
            error: function(err) {
                console.log("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", err);
                document.getElementById('loadingMsg').textContent = 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
            }
        });
    }

    // â–¼ å‹•ç‰©åœ’ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ç”Ÿæˆ
    function populateZooFilter() {
        const zoos = [...new Set(koalaData.map(k => k.zoo).filter(z => z))].sort();
        const select = document.getElementById('zooFilter');
        zoos.forEach(zoo => {
            const option = document.createElement('option');
            option.value = zoo;
            option.textContent = zoo;
            select.appendChild(option);
        });
    }

    // â–¼ ç”Ÿæ­»ã«åŸºã¥ã„ã¦ã‚½ãƒ¼ãƒˆã™ã‚‹é–¢æ•°ï¼ˆå­˜å‘½ãŒå…ˆã€å¤©å›½ãŒå¾Œï¼‰
    function sortKoalasByLife(list) {
        return list.sort((a, b) => {
            const aIsDead = (a.death && a.death !== "");
            const bIsDead = (b.death && b.death !== "");
            
            if (aIsDead === bIsDead) return 0; // ã©ã¡ã‚‰ã‚‚åŒã˜çŠ¶æ…‹ãªã‚‰é †ç•ªãã®ã¾ã¾
            return aIsDead ? 1 : -1; // å¤©å›½(true)ãªã‚‰å¾Œã‚ã¸
        });
    }

    // â–¼ ä»Šæœˆèª•ç”Ÿæ—¥ã‚’è¡¨ç¤ºï¼ˆå­˜å‘½å„ªå…ˆï¼‹å¤©å›½ã†ã£ã™ã‚‰ï¼‰
    function showBirthdayKoalas() {
        const today = new Date();
        const currentMonth = today.getMonth() + 1;
        
        document.getElementById('birthdayTitle').textContent = `ğŸ‰ ä»Šæœˆï¼ˆ${currentMonth}æœˆï¼‰ã®ãŠèª•ç”Ÿæ—¥ ğŸ‰`;

        // ä»Šæœˆç”Ÿã¾ã‚Œã‚’æŠ½å‡ºï¼ˆå¤©å›½ã®å­ã‚‚å«ã‚ã‚‹ï¼‰
        let birthdayKoalas = koalaData.filter(k => {
            if (!k.birthday) return false;
            const parts = k.birthday.split(/[-/]/); 
            if (parts.length < 2) return false;
            return parseInt(parts[1], 10) === currentMonth;
        });

        if (birthdayKoalas.length === 0) {
            document.getElementById('birthdaySection').style.display = 'none';
            return;
        }

        // â˜… ä¸¦ã³æ›¿ãˆï¼šå­˜å‘½ -> å¤©å›½
        birthdayKoalas = sortKoalasByLife(birthdayKoalas);

        const list = document.getElementById('birthdayList');
        document.getElementById('birthdaySection').style.display = 'block';

        birthdayKoalas.forEach(koala => {
            const isDead = (koala.death && koala.death !== "");
            // å¤©å›½ã®å­ãªã‚‰å°‚ç”¨ã‚¯ãƒ©ã‚¹ã‚’ã¤ã‘ã‚‹
            const deadClass = isDead ? 'deceased-style' : '';
            const nameSuffix = isDead ? ' (ğŸŒˆ)' : ''; // åå‰ã«ã‚‚è™¹ãƒãƒ¼ã‚¯ã‚’ã¤ã‘ã‚‹

            const div = document.createElement('div');
            div.className = `birthday-card ${deadClass}`;
            div.innerHTML = `
                <div style="font-weight:bold; font-size:1.1em;">${koala.name}${nameSuffix}</div>
                <div style="font-size:0.8em; color:#666;">${koala.zoo}</div>
                <div style="color:#e65100; margin-top:5px;">ğŸ‚ ${koala.birthday}</div>
                <div style="font-size:0.8em; margin-top:3px;">${koala.age}</div>
            `;
            list.appendChild(div);
        });
    }

    // â–¼ ãƒ©ãƒ³ãƒ€ãƒ ã«ãŠã™ã™ã‚ã‚³ã‚¢ãƒ©ã‚’è¡¨ç¤ºï¼ˆãƒˆãƒƒãƒ—ç”¨ï¼‰
    function showRandomKoalas(count) {
        // å…¨ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«æŠ½å‡º
        const shuffled = [...koalaData].sort(() => 0.5 - Math.random());
        const selected = shuffled.slice(0, count);

        document.getElementById('recommendTitle').style.display = 'block';
        renderKoalas(selected);
    }

    // â–¼ ãƒªã‚¹ãƒˆè¡¨ç¤ºï¼ˆå­˜å‘½å„ªå…ˆï¼‹å¤©å›½ã†ã£ã™ã‚‰ï¼‰
    function renderKoalas(data) {
        const list = document.getElementById('koalaList');
        // ã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä»¥å¤–ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹ãŸã‚ã®å‡¦ç†
        // ï¼ˆrecommendTitleã‚„loadingMsgã‚’æ¶ˆã•ãªã„ã‚ˆã†ã«æ³¨æ„ã—ã¦å†æç”»ï¼‰
        const title = document.getElementById('recommendTitle');
        const loader = document.getElementById('loadingMsg');
        list.innerHTML = ''; 
        list.appendChild(title); // ã‚¿ã‚¤ãƒˆãƒ«æˆ»ã™
        list.appendChild(loader); // ãƒ­ãƒ¼ãƒ€ãƒ¼æˆ»ã™ï¼ˆéè¡¨ç¤ºã ã‘ã©ï¼‰

        if (data.length === 0) {
            const p = document.createElement('p');
            p.textContent = 'è©²å½“ã™ã‚‹ã‚³ã‚¢ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
            p.style.textAlign = 'center';
            p.style.gridColumn = '1/-1';
            list.appendChild(p);
            return;
        }

        data.forEach(koala => {
            let genderClass = 'other';
            if (koala.gender && koala.gender.includes('ã‚ªã‚¹')) genderClass = 'male';
            if (koala.gender && koala.gender.includes('ãƒ¡ã‚¹')) genderClass = 'female';

            // â˜… å¤©å›½åˆ¤å®š
            const isDead = (koala.death && koala.death !== "");
            const deadClass = isDead ? 'deceased-style' : '';
            const statusIcon = isDead ? 'ğŸŒˆ ' : '';

            // URLå‡¦ç†
            let zooDisplay = `ğŸ“ ${koala.zoo}`;
            const url = zooUrls[koala.zoo];
            if (url) {
                zooDisplay = `<a href="${url}" target="_blank" class="zoo-link">ğŸ“ ${koala.zoo} <span class="link-icon">ğŸ”—</span></a>`;
            }

            const div = document.createElement('div');
            div.className = `koala-card ${deadClass}`; // ã“ã“ã«ã‚°ãƒ¬ãƒ¼ã«ã™ã‚‹ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
            div.innerHTML = `
                <div class="koala-header">
                    <div class="koala-name">${statusIcon}${koala.name}</div>
                    <span class="badge ${genderClass}">${koala.gender || "ä¸æ˜"}</span>
                    <span class="badge age">${koala.age || "-"}</span>
                </div>

                <div class="koala-zoo">${zooDisplay}</div>

                <div class="detail-grid">
                    <span class="label-icon">ğŸ‚</span> <span>${koala.birthday}</span>
                    <span class="label-icon">ğŸ¨</span> <span>çˆ¶ï¼š${koala.father || "-"}</span>
                    <span class="label-icon">ğŸ¨</span> <span>æ¯ï¼š${koala.mother || "-"}</span>
                </div>
                
                ${koala.memo ? `<div class="memo-text">${koala.memo}</div>` : ''}
            `;
            list.appendChild(div);
        });
    }

    // â–¼ æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿æ©Ÿèƒ½ï¼ˆå…¥åŠ›æ™‚ï¼‰
    function filterKoalas() {
        const textInput = document.getElementById('searchInput').value.toLowerCase();
        const zooSelect = document.getElementById('zooFilter').value;
        
        // ä½•ã‚‚å…¥åŠ›ãŒãªã„æ™‚ã¯ã€ŒãŠã™ã™ã‚ã€ã«æˆ»ã™ï¼Ÿ
        // ã„ã‚„ã€æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã‚’è§¦ã£ãŸã‚‰å…¨ãƒªã‚¹ãƒˆã‹ã‚‰æ¢ã—ãŸã„ã¯ãšãªã®ã§å…¨ä»¶å¯¾è±¡ã«ã™ã‚‹
        if (textInput === '' && zooSelect === '') {
            document.getElementById('recommendTitle').style.display = 'block'; // ãŠã™ã™ã‚ã‚¿ã‚¤ãƒˆãƒ«å‡ºã™
            showRandomKoalas(3); // ã¾ãŸãƒ©ãƒ³ãƒ€ãƒ 3é ­ã«æˆ»ã™ï¼ˆã¾ãŸã¯å…¨ä»¶å‡ºã—ã¦ã‚‚è‰¯ã„ã§ã™ãŒã€ãŠã™ã™ã‚ã«æˆ»ã—ã¾ã™ï¼‰
            return;
        }

        // æ¤œç´¢ä¸­ã¯ã€ŒãŠã™ã™ã‚ã€ã‚¿ã‚¤ãƒˆãƒ«ã‚’éš ã™
        document.getElementById('recommendTitle').style.display = 'none';

        let filtered = koalaData.filter(koala => {
            const matchesText = (koala.name + koala.memo).toLowerCase().includes(textInput);
            const matchesZoo = zooSelect === "" || koala.zoo === zooSelect;
            return matchesText && matchesZoo;
        });
        
        // â˜… ã“ã“ã§ä¸¦ã³æ›¿ãˆï¼ˆå­˜å‘½ -> å¤©å›½ï¼‰
        filtered = sortKoalasByLife(filtered);

        renderKoalas(filtered);
    }

    window.addEventListener('load', loadFromSpreadsheet);
</script>
</body>
</html>