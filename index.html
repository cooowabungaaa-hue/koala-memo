<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚³ã‚¢ãƒ©ãƒ¡ãƒ¢</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2e7d32">
    <link rel="apple-touch-icon" href="koalaface.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        /* â–¼ å…¨ä½“ã®è¨­å®š */
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
            padding: 20px;
            padding-top: env(safe-area-inset-top);
        }

        header {
            text-align: center;
            margin-bottom: 20px;
        }

        h1 {
            color: #2e7d32;
            margin: 0;
            font-size: 1.8em;
            cursor: pointer;
        }
        
        p.subtitle {
            color: #666;
            font-size: 0.8em;
            margin-top: 5px;
        }

        #backButton {
            display: none;
            margin: 0 auto 20px auto;
            background-color: #666;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
        }

        /* â–¼ ãŠèª•ç”Ÿæ—¥ã‚¨ãƒªã‚¢ */
        #birthdaySection {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 30px;
            display: none;
            border: 2px solid #ffcc80;
            text-align: center;
        }
        .birthday-title {
            text-align: center; color: #e65100; font-weight: bold; margin-bottom: 12px; font-size: 1.1em;
        }

        .month-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .month-btn {
            background-color: white;
            border: 1px solid #ffcc80;
            color: #e65100;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            cursor: pointer;
            font-weight: bold;
        }
        .month-btn.active {
            background-color: #e65100;
            color: white;
            border-color: #e65100;
        }

        .birthday-list {
            display: flex; overflow-x: auto; gap: 15px; padding-bottom: 5px; margin-bottom: 10px;
            text-align: left;
        }
        .birthday-card {
            background: white; padding: 10px; border-radius: 8px; min-width: 200px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-top: 4px solid #ff9800; flex-shrink: 0;
        }

        .toggle-dead-btn {
            background-color: transparent;
            border: 1px solid #e65100;
            color: #e65100;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.8em;
            cursor: pointer;
            margin-top: 5px;
        }

        /* â–¼ æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã‚¨ãƒªã‚¢ */
        .search-container {
            margin-bottom: 25px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        .search-group {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 12px;
        }
        .search-label {
            display: block;
            font-size: 0.85em;
            font-weight: bold;
            color: #2e7d32;
            margin-bottom: 8px;
            text-align: left;
        }
        .search-inputs {
            display: flex; gap: 10px;
        }
        input[type="text"], select {
            width: 100%;
            padding: 12px;
            border: 2px solid #eee;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            box-sizing: border-box;
            background-color: #fafafa;
        }
        input[type="text"]:focus, select:focus {
            border-color: #2e7d32;
            background-color: #fff;
        }

        /* â–¼ ãƒ¡ã‚¤ãƒ³ã®ã‚³ã‚¢ãƒ©ãƒªã‚¹ãƒˆ */
        .koala-list {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px; max-width: 1000px; margin: 0 auto;
        }

        .section-title {
            grid-column: 1 / -1; text-align: center; font-weight: bold; color: #2e7d32;
            margin: 10px 0; display: none; font-size: 1.2em;
        }

        /* â–¼ ã‚³ã‚¢ãƒ©ã‚«ãƒ¼ãƒ‰ */
        .koala-card {
            background: white; padding: 20px; border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-left: 5px solid #2e7d32;
            transition: transform 0.2s; position: relative;
        }
        .koala-card:active { transform: scale(0.98); }

        .deceased-style {
            background-color: #f0f0f0; opacity: 0.9; border-color: #ccc !important; color: #666;
        }
        .deceased-style .badge.age { background-color: #999; }
        .deceased-style .koala-zoo { background-color: #eee; color: #666; }

        .parent-hero {
            grid-column: 1 / -1;
            background-color: #e8f5e9;
            border: 2px solid #2e7d32;
        }

        .koala-header { display: flex; align-items: center; flex-wrap: wrap; gap: 8px; margin-bottom: 8px; }
        .koala-name { font-size: 1.4em; font-weight: bold; color: #333; }
        
        .badge { font-size: 0.75em; padding: 3px 8px; border-radius: 12px; color: white; font-weight: normal; }
        .male { background-color: #4A90E2; }
        .female { background-color: #E24A8D; }
        .other { background-color: #999; }
        .age { background-color: #2ecc71; }

        .koala-zoo {
            display: inline-block; background-color: #e8f5e9; color: #2e7d32;
            padding: 4px 10px; border-radius: 4px; font-size: 0.9em; font-weight: bold; margin-bottom: 12px;
        }

        .detail-grid {
            display: grid; grid-template-columns: auto 1fr; gap: 5px 10px; font-size: 0.95em; color: #444;
        }
        .label-icon { color: #888; width: 20px; text-align: center; }
        .memo-text {
            margin-top: 12px; padding: 10px; background-color: #f9f9f9; border-radius: 6px;
            font-size: 0.9em; color: #555; line-height: 1.5;
        }

        a.zoo-link { text-decoration: none; color: inherit; display: inline-flex; align-items: center; gap: 5px; }
        a.zoo-link:hover { opacity: 0.7; text-decoration: underline; }

        .parent-link {
            color: #2e7d32;
            text-decoration: underline;
            cursor: pointer;
            font-weight: bold;
        }

        .family-btn {
            flex: 1;
            padding: 8px;
            background-color: #fff3e0;
            color: #e65100;
            border: 1px solid #ffcc80;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            display: flex; align-items: center; justify-content: center; gap: 5px;
            font-size: 0.9em;
        }
        .family-btn:hover { background-color: #ffe0b2; }

        /* â–¼ ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€šè¨­å®š */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; width: 95%; max-width: 500px; border-radius: 12px;
            padding: 20px; position: relative; max-height: 90vh; overflow-y: auto;
            box-sizing: border-box;
        }
        .close-btn {
            position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #666;
            z-index: 10;
        }
        
        /* å®¶æ—ã•ã‚“ï¼ˆæ—§ï¼šè¡€çµ±è¡¨ï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .pedigree-table {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr; /* å·¦:ç¥–çˆ¶æ¯ã€ä¸­:è¦ªã€å³:è‡ªåˆ† */
            grid-template-rows: repeat(4, 1fr); /* 4è¡Œå›ºå®š */
            gap: 4px; margin-top: 15px; border: 2px solid #2e7d32; background-color: #2e7d32;
        }
        .ped-cell {
            background-color: #f9f9f9; display: flex; flex-direction: column;
            justify-content: center; align-items: center; padding: 8px 2px;
            text-align: center; font-size: 0.8em;
        }

        /* â–¼ é…ç½®ã®åº§å¸­æŒ‡å®š (Left=Grandparents, Mid=Parents, Right=Self) */
        .ped-pos-ff { grid-column: 1; grid-row: 1; }      /* çˆ¶çˆ¶ (å·¦ä¸Š) */
        .ped-pos-fm { grid-column: 1; grid-row: 2; }      /* çˆ¶æ¯ (å·¦ä¸­ä¸Š) */
        .ped-pos-father { grid-column: 2; grid-row: 1 / 3; } /* çˆ¶ (ä¸­ä¸Šãƒ»2è¡Œåˆ†) */
        
        .ped-pos-mf { grid-column: 1; grid-row: 3; }      /* æ¯çˆ¶ (å·¦ä¸­ä¸‹) */
        .ped-pos-mm { grid-column: 1; grid-row: 4; }      /* æ¯æ¯ (å·¦ä¸‹) */
        .ped-pos-mother { grid-column: 2; grid-row: 3 / 5; } /* æ¯ (ä¸­ä¸‹ãƒ»2è¡Œåˆ†) */
        
        .ped-pos-self { grid-column: 3; grid-row: 1 / 5; font-size: 1.1em; background-color: #e8f5e9; font-weight: bold; } /* è‡ªåˆ† (å³ãƒ»å…¨è¡Œ) */

        .ped-male { border-left: 3px solid #4A90E2; }
        .ped-female { border-left: 3px solid #E24A8D; }

        /* ãã‚‡ã†ã ã„ãƒªã‚¹ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .sibling-section { margin-top: 20px; }
        .sibling-title {
            font-weight: bold; color: #2e7d32; border-bottom: 2px solid #a5d6a7;
            margin-bottom: 10px; padding-bottom: 5px; font-size: 1em;
        }
        .sibling-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px; border-bottom: 1px solid #eee; cursor: pointer;
        }
        .sibling-item:hover { background-color: #f5f5f5; }
        .sibling-name { font-weight: bold; color: #333; display: flex; align-items: center; gap: 5px; }

    </style>
</head>
<body>

<header>
    <h1 onclick="resetApp()">ğŸ¨ ã‚³ã‚¢ãƒ©ãƒ¡ãƒ¢ ğŸ¨</h1>
    <p class="subtitle">Japan Koala Database</p>
</header>

<button id="backButton" onclick="resetApp()">â† ä¸€è¦§ã«æˆ»ã‚‹</button>

<div id="birthdaySection">
    <div class="birthday-title" id="birthdayTitle">ğŸ‰ ä»Šæœˆã®ãŠèª•ç”Ÿæ—¥ ğŸ‰</div>
    <div class="month-tabs">
        <button id="btnCurrentMonth" class="month-btn active" onclick="changeBirthdayMonth(0)">ä»Šæœˆ</button>
        <button id="btnNextMonth" class="month-btn" onclick="changeBirthdayMonth(1)">æ¥æœˆ</button>
    </div>
    <div class="birthday-list" id="birthdayList"></div>
    <div id="birthdayToggleContainer"></div>
</div>

<div class="search-container" id="searchContainer">
    <div class="search-group">
        <label class="search-label">ğŸ” ãªã¾ãˆã§æ¤œç´¢</label>
        <div class="search-inputs">
            <input type="text" id="searchInput" placeholder="ä¾‹ï¼šã“ã¾ã¡ã€ãã‚‰ã‚‰..." onkeyup="filterByName()">
        </div>
    </div>
    <div class="search-group">
        <label class="search-label">ğŸ“ å‹•ç‰©åœ’ã‹ã‚‰æ¢ã™</label>
        <div class="search-inputs">
            <select id="zooFilter" onchange="filterByZoo()">
                <option value="">å‹•ç‰©åœ’ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
        </div>
    </div>
</div>

<div id="koalaList" class="koala-list">
    <div id="listTitle" class="section-title"></div>
    <div id="loadingMsg" style="text-align:center; color:#999; grid-column:1/-1;">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
</div>

<div id="pedigreeModal" class="modal-overlay" onclick="closeModals(event)">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModals(event)">Ã—</span>
        <h2 style="text-align:center; color:#2e7d32; margin:0;">ğŸ§¬ å®¶æ—ã•ã‚“</h2>
        <div id="pedigreeChart" class="pedigree-table"></div>
    </div>
</div>

<div id="siblingModal" class="modal-overlay" onclick="closeModals(event)">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModals(event)">Ã—</span>
        <h2 style="text-align:center; color:#2e7d32; margin:0;">ğŸ’ ãã‚‡ã†ã ã„</h2>
        <div id="siblingListContent"></div>
    </div>
</div>

<script>
    let koalaData = [];
    let showDeceasedBirthday = false;
    let currentBirthdayOffset = 0;

    const zooUrls = {
        "æ±å±±": "https://www.higashiyama.city.nagoya.jp/", "æ±å±±å‹•æ¤ç‰©åœ’": "https://www.higashiyama.city.nagoya.jp/",
        "å¤šæ‘©": "https://www.tokyo-zoo.net/zoo/tama/", "å¤šæ‘©å‹•ç‰©å…¬åœ’": "https://www.tokyo-zoo.net/zoo/tama/",
        "åŸ¼ç‰": "https://www.parks.or.jp/sczoo/", "åŸ¼ç‰çœŒã“ã©ã‚‚": "https://www.parks.or.jp/sczoo/", "åŸ¼ç‰çœŒã“ã©ã‚‚å‹•ç‰©è‡ªç„¶å…¬åœ’": "https://www.parks.or.jp/sczoo/",
        "å¹³å·": "https://hirakawazoo.jp/", "å¹³å·å‹•ç‰©å…¬åœ’": "https://hirakawazoo.jp/",
        "é‡‘æ²¢": "https://www.hama-midorinokyokai.or.jp/zoo/kanazawa/", "æ¨ªæµœé‡‘æ²¢": "https://www.hama-midorinokyokai.or.jp/zoo/kanazawa/", "é‡‘æ²¢å‹•ç‰©åœ’": "https://www.hama-midorinokyokai.or.jp/zoo/kanazawa/", "æ¨ªæµœå¸‚ç«‹é‡‘æ²¢å‹•ç‰©åœ’": "https://www.hama-midorinokyokai.or.jp/zoo/kanazawa/",
        "ç‹å­": "https://www.kobe-ojizoo.jp/", "ç¥æˆ¸å¸‚ç‹å­": "https://www.kobe-ojizoo.jp/", "ç¥æˆ¸å¸‚ç«‹ç‹å­å‹•ç‰©åœ’": "https://www.kobe-ojizoo.jp/",
        "æ·¡è·¯": "https://www.england-hill.com/", "ã‚¤ãƒ³ã‚°ãƒ©ãƒ³ãƒ‰ã®ä¸˜": "https://www.england-hill.com/",
        "å¤©ç‹å¯º": "https://www.tennojizoo.jp/", "å¤©ç‹å¯ºå‹•ç‰©åœ’": "https://www.tennojizoo.jp/"
    };

    function loadFromSpreadsheet() {
        const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQi6GZ0pWmE1A0MSJBoSyHYaKvAHkgFeBRvZPmMHqHLBh53VzAr5nyJ43qOVuTj4y2xus5nzzurKmUX/pub?gid=107153803&single=true&output=csv";

        Papa.parse(sheetUrl, {
            download: true, header: true,
            complete: function(results) {
                koalaData = results.data.filter(item => item.name && item.name !== "");
                document.getElementById('loadingMsg').style.display = 'none';
                populateZooFilter();
                showBirthdayKoalas();
                showRandomKoalas(3);
            },
            error: function(err) {
                document.getElementById('loadingMsg').textContent = 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
            }
        });
    }

    function checkIsDead(koala) {
        return (koala.death && koala.death !== "") || (koala.age === "æ²¡å¹´é½¢ä¸æ˜");
    }

    function resetApp() {
        document.getElementById('backButton').style.display = 'none';
        document.getElementById('birthdaySection').style.display = 'block';
        document.getElementById('searchContainer').style.display = 'block';
        document.getElementById('searchInput').value = '';
        document.getElementById('zooFilter').value = '';
        currentBirthdayOffset = 0;
        showBirthdayKoalas();
        showRandomKoalas(3);
        window.scrollTo(0, 0);
    }

    // å˜ä¸€ã®ã‚³ã‚¢ãƒ©ã‚’è¡¨ç¤ºã™ã‚‹æ©Ÿèƒ½ï¼ˆè©³ç´°ãƒšãƒ¼ã‚¸ã¸ã‚¸ãƒ£ãƒ³ãƒ—ï¼‰
    function jumpToKoala(koalaId) {
        document.getElementById('pedigreeModal').style.display = 'none';
        document.getElementById('siblingModal').style.display = 'none';
        
        const target = koalaData.find(k => k.id === koalaId);
        if (!target) return;

        document.getElementById('birthdaySection').style.display = 'none';
        document.getElementById('searchContainer').style.display = 'none';
        document.getElementById('backButton').style.display = 'block';
        
        const list = document.getElementById('koalaList');
        const title = document.getElementById('listTitle');
        list.innerHTML = '';
        title.style.display = 'none';

        renderCard(target, list, true);
        window.scrollTo(0, 0);
    }

    function showFamily(koalaId) {
        const parent = koalaData.find(k => k.id === koalaId);
        if (!parent) return;

        let children = koalaData.filter(k => 
            (k.mother_id && k.mother_id === koalaId) || (k.father_id && k.father_id === koalaId)
        );

        document.getElementById('birthdaySection').style.display = 'none';
        document.getElementById('searchContainer').style.display = 'none';
        document.getElementById('backButton').style.display = 'block';
        
        const list = document.getElementById('koalaList');
        const title = document.getElementById('listTitle');
        list.innerHTML = '';
        
        title.style.display = 'block';
        title.innerHTML = `ğŸ¥° ${parent.name} ã®å®¶ç³» (ã“ã©ã‚‚ ${children.length}é ­)`;
        list.appendChild(title);

        renderCard(parent, list, true);

        if (children.length > 0) {
            children.sort((a, b) => new Date(a.birthday) - new Date(b.birthday));
            children.forEach(child => renderCard(child, list));
        } else {
            const p = document.createElement('p');
            p.textContent = 'è¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹å­ä¾›ã¯ã„ã¾ã›ã‚“';
            p.style.textAlign = 'center'; p.style.color = '#999'; p.style.gridColumn = '1/-1';
            list.appendChild(p);
        }
        window.scrollTo(0, 0);
    }

    // â–¼ ãã‚‡ã†ã ã„è¡¨ç¤ºæ©Ÿèƒ½
    function showSiblings(id) {
        const self = koalaData.find(k => k.id === id);
        if (!self) return;

        const isValidParent = (parentId, parentName) => {
            if (!parentId || !parentName) return false;
            const ngWords = ["ä¸æ˜", "ã‚ªãƒ¼ã‚¸ãƒ¼", "æœªç™»éŒ²", "èª¿æŸ»ä¸­"];
            return !ngWords.some(word => parentName.includes(word));
        };

        const hasValidFather = isValidParent(self.father_id, self.father);
        const hasValidMother = isValidParent(self.mother_id, self.mother);

        let fullSiblings = [];
        if (hasValidFather && hasValidMother) {
            fullSiblings = koalaData.filter(k => 
                k.id !== self.id &&
                k.father_id === self.father_id &&
                k.mother_id === self.mother_id
            );
        }

        let maternalSiblings = [];
        if (hasValidMother) {
            maternalSiblings = koalaData.filter(k => 
                k.id !== self.id &&
                k.mother_id === self.mother_id &&
                k.father_id !== self.father_id 
            );
        }

        let paternalSiblings = [];
        if (hasValidFather) {
            paternalSiblings = koalaData.filter(k => 
                k.id !== self.id &&
                k.father_id === self.father_id &&
                k.mother_id !== self.mother_id 
            );
        }

        const content = document.getElementById('siblingListContent');
        content.innerHTML = ''; 

        if (!hasValidFather && !hasValidMother) {
            content.innerHTML = '<p style="text-align:center; color:#999; margin-top:30px;">ä¸¡è¦ªã®æƒ…å ±ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ãªã„ã€ã¾ãŸã¯ä¸æ˜ãªãŸã‚ã€ãã‚‡ã†ã ã„ã‚’è¡¨ç¤ºã§ãã¾ã›ã‚“</p>';
            document.getElementById('siblingModal').style.display = 'flex';
            return;
        }

        if (fullSiblings.length === 0 && maternalSiblings.length === 0 && paternalSiblings.length === 0) {
            content.innerHTML = '<p style="text-align:center; color:#999; margin-top:30px;">è¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹å…„å¼Ÿå§‰å¦¹ã¯ã„ã¾ã›ã‚“</p>';
        } else {
            if (fullSiblings.length > 0) renderSiblingSection(content, `ğŸ’– å…¨ãã‚‡ã†ã ã„ï¼ˆ${self.father} & ${self.mother}ï¼‰`, fullSiblings);
            if (maternalSiblings.length > 0) renderSiblingSection(content, `ğŸ§¡ ãŠæ¯ã•ã‚“ï¼ˆ${self.mother}ï¼‰`, maternalSiblings);
            if (paternalSiblings.length > 0) renderSiblingSection(content, `ğŸ’™ ãŠçˆ¶ã•ã‚“ï¼ˆ${self.father}ï¼‰`, paternalSiblings);
        }

        document.getElementById('siblingModal').style.display = 'flex';
    }

    function renderSiblingSection(container, title, list) {
        list.sort((a, b) => new Date(a.birthday) - new Date(b.birthday));

        const section = document.createElement('div');
        section.className = 'sibling-section';
        
        const h3 = document.createElement('div');
        h3.className = 'sibling-title';
        h3.textContent = title;
        section.appendChild(h3);

        list.forEach(k => {
            const isDead = checkIsDead(k);
            const genderColor = k.gender?.includes('ã‚ªã‚¹') ? '#4A90E2' : (k.gender?.includes('ãƒ¡ã‚¹') ? '#E24A8D' : '#999');
            const row = document.createElement('div');
            row.className = 'sibling-item';
            row.onclick = () => jumpToKoala(k.id); 
            row.innerHTML = `
                <div>
                    <div class="sibling-name">
                        <span style="color:${genderColor};">â—</span>
                        ${k.name} ${isDead ? '<span style="font-size:0.8em">ğŸŒˆ</span>' : ''}
                    </div>
                    <div style="font-size:0.8em; color:#666;">${k.zoo}</div>
                </div>
                <div style="font-size:0.85em; color:#e65100;">${k.birthday || '-'}</div>
            `;
            section.appendChild(row);
        });

        container.appendChild(section);
    }

    // â–¼ å®¶æ—ã•ã‚“ã‚’è¡¨ç¤ºã™ã‚‹æ©Ÿèƒ½
    function showPedigree(id) {
        const self = koalaData.find(k => k.id === id);
        if (!self) return;

        const father = koalaData.find(k => k.id === self.father_id);
        const mother = koalaData.find(k => k.id === self.mother_id);
        
        const ff = father ? koalaData.find(k => k.id === father.father_id) : null;
        const fm = father ? koalaData.find(k => k.id === father.mother_id) : null;
        const mf = mother ? koalaData.find(k => k.id === mother.father_id) : null;
        const mm = mother ? koalaData.find(k => k.id === mother.mother_id) : null;

        const getName = (k, defaultText) => k ? k.name : (defaultText || "ä¸æ˜");
        const getStyle = (k) => k ? (k.gender === 'ã‚ªã‚¹' ? 'ped-male' : 'ped-female') : '';

        // HTMLç”Ÿæˆï¼ˆé…ç½®ã¯CSSã®åº§å¸­æŒ‡å®šã§è¡Œã†ãŸã‚é †ç•ªã¯è‡ªç”±ã§ã™ãŒã€ã‚ã‹ã‚Šã‚„ã™ãè¨˜è¿°ï¼‰
        const html = `
            <div class="ped-cell ped-pos-self ${getStyle(self)}">
                ${self.name}
            </div>
            
            <div class="ped-cell ped-pos-father ${getStyle(father)}">
                ${getName(father, "ä¸æ˜")}
            </div>
            
            <div class="ped-cell ped-pos-mother ${getStyle(mother)}">
                ${getName(mother, "ä¸æ˜")}
            </div>
            
            <div class="ped-cell ped-pos-ff ${getStyle(ff)}">
                ${getName(ff, "ä¸æ˜")}
            </div>
            <div class="ped-cell ped-pos-fm ${getStyle(fm)}">
                ${getName(fm, "ä¸æ˜")}
            </div>
            <div class="ped-cell ped-pos-mf ${getStyle(mf)}">
                ${getName(mf, "ä¸æ˜")}
            </div>
            <div class="ped-cell ped-pos-mm ${getStyle(mm)}">
                ${getName(mm, "ä¸æ˜")}
            </div>
        `;

        document.getElementById('pedigreeChart').innerHTML = html;
        document.getElementById('pedigreeModal').style.display = 'flex';
    }

    function closeModals(e) {
        if (e.target.className === 'modal-overlay' || e.target.className === 'close-btn') {
            document.getElementById('pedigreeModal').style.display = 'none';
            document.getElementById('siblingModal').style.display = 'none';
        }
    }

    function renderCard(koala, container, isHero = false) {
        let genderClass = (koala.gender?.includes('ã‚ªã‚¹')) ? 'male' : (koala.gender?.includes('ãƒ¡ã‚¹') ? 'female' : 'other');
        const isDead = checkIsDead(koala);
        const deadClass = isDead ? 'deceased-style' : '';
        const statusIcon = isDead ? 'ğŸŒˆ ' : '';

        let zooDisplay = `ğŸ“ ${koala.zoo}`;
        const url = zooUrls[koala.zoo];
        if (url) zooDisplay = `<a href="${url}" target="_blank" class="zoo-link">ğŸ“ ${koala.zoo} ğŸ”—</a>`;

        const fatherDisplay = koala.father_id 
            ? `<span class="parent-link" onclick="jumpToKoala('${koala.father_id}')">${koala.father}</span>` 
            : (koala.father || "-");
        const motherDisplay = koala.mother_id 
            ? `<span class="parent-link" onclick="jumpToKoala('${koala.mother_id}')">${koala.mother}</span>` 
            : (koala.mother || "-");

        const div = document.createElement('div');
        div.className = `koala-card ${deadClass} ${isHero ? 'parent-hero' : ''}`;
        
        const buttons = koala.id ? `
            <div style="display:flex; gap:8px; margin-top:15px;">
                <button class="family-btn" onclick="showPedigree('${koala.id}')">ğŸ§¬ å®¶æ—ã•ã‚“</button>
                <button class="family-btn" onclick="showSiblings('${koala.id}')">ğŸ’ ãã‚‡ã†ã ã„</button>
                <button class="family-btn" onclick="showFamily('${koala.id}')">ğŸ¥° ã“ã©ã‚‚</button>
            </div>
        ` : '';

        div.innerHTML = `
            <div class="koala-header">
                <div class="koala-name">${statusIcon}${koala.name}</div>
                <span class="badge ${genderClass}">${koala.gender || "ä¸æ˜"}</span>
                <span class="badge age">${koala.age || "-"}</span>
            </div>
            <div class="koala-zoo">${zooDisplay}</div>
            <div class="detail-grid">
                <span class="label-icon">ğŸ‚</span> <span>${koala.birthday}</span>
                <span class="label-icon">ğŸ’™</span> <span>çˆ¶ï¼š${fatherDisplay}</span>
                <span class="label-icon">ğŸ§¡</span> <span>æ¯ï¼š${motherDisplay}</span>
            </div>
            ${koala.memo ? `<div class="memo-text">${koala.memo}</div>` : ''}
            ${buttons}
        `;
        container.appendChild(div);
    }

    function renderKoalas(data) {
        const list = document.getElementById('koalaList');
        const title = document.getElementById('listTitle');
        list.innerHTML = '';
        list.appendChild(title);
        if (data.length === 0) {
            const p = document.createElement('p');
            p.textContent = 'è©²å½“ã™ã‚‹ã‚³ã‚¢ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
            p.style.textAlign = 'center'; p.style.gridColumn = '1/-1';
            list.appendChild(p);
            return;
        }
        data.forEach(koala => renderCard(koala, list));
    }

    function populateZooFilter() {
        const zoos = [...new Set(koalaData.map(k => k.zoo).filter(z => z))].sort();
        const select = document.getElementById('zooFilter');
        select.innerHTML = '<option value="">å‹•ç‰©åœ’ã‚’é¸æŠã—ã¦ãã ã•ã„</option>'; 
        zoos.forEach(zoo => {
            const option = document.createElement('option');
            option.value = zoo; option.textContent = zoo; select.appendChild(option);
        });
    }

    function sortKoalasByLife(list) {
        return list.sort((a, b) => {
            const aDead = checkIsDead(a);
            const bDead = checkIsDead(b);
            return aDead === bDead ? 0 : (aDead ? 1 : -1);
        });
    }

    function filterByName() {
        const text = document.getElementById('searchInput').value.toLowerCase();
        document.getElementById('zooFilter').value = "";
        if (!text) { showRandomKoalas(3); return; }
        document.getElementById('listTitle').style.display = 'block';
        document.getElementById('listTitle').textContent = `ğŸ” ã€Œ${text}ã€ã®æ¤œç´¢çµæœ`;
        let filtered = koalaData.filter(k => 
            (k.name + k.memo).toLowerCase().includes(text)
        );
        renderKoalas(sortKoalasByLife(filtered));
    }

    function filterByZoo() {
        const zoo = document.getElementById('zooFilter').value;
        document.getElementById('searchInput').value = "";
        if (!zoo) { showRandomKoalas(3); return; }
        let filtered = koalaData.filter(k => k.zoo === zoo);
        let livingCount = filtered.filter(k => !checkIsDead(k)).length;
        document.getElementById('listTitle').style.display = 'block';
        document.getElementById('listTitle').textContent = `ğŸ“ ${zoo}ï¼ˆä¼šãˆã‚‹å­ï¼š${livingCount}é ­ï¼‰`;
        renderKoalas(sortKoalasByLife(filtered));
    }

    function changeBirthdayMonth(offset) {
        currentBirthdayOffset = offset;
        showBirthdayKoalas();
    }

    function toggleBirthdayView() {
        showDeceasedBirthday = !showDeceasedBirthday;
        showBirthdayKoalas();
    }

    function showBirthdayKoalas() {
        const now = new Date();
        const targetDate = new Date(now.getFullYear(), now.getMonth() + currentBirthdayOffset, 1);
        const targetMonth = targetDate.getMonth() + 1;
        const section = document.getElementById('birthdaySection');
        const list = document.getElementById('birthdayList');
        const toggleContainer = document.getElementById('birthdayToggleContainer');
        const titleArea = document.getElementById('birthdayTitle');
        document.getElementById('btnCurrentMonth').className = (currentBirthdayOffset === 0) ? 'month-btn active' : 'month-btn';
        document.getElementById('btnNextMonth').className = (currentBirthdayOffset === 1) ? 'month-btn active' : 'month-btn';
        list.innerHTML = '';
        toggleContainer.innerHTML = '';
        titleArea.textContent = currentBirthdayOffset === 0 ? `ğŸ‰ ä»Šæœˆï¼ˆ${targetMonth}æœˆï¼‰ã®ãŠèª•ç”Ÿæ—¥ ğŸ‰` : `ğŸ ã‚‚ã†ã™ãï¼ˆ${targetMonth}æœˆï¼‰ãŠèª•ç”Ÿæ—¥ ğŸ`;
        let allBirthdays = koalaData.filter(k => {
            const p = k.birthday?.split(/[-/]/);
            return p && p.length >= 2 && parseInt(p[1], 10) === targetMonth;
        });
        const livingBirthdays = allBirthdays.filter(k => !checkIsDead(k));
        const deceasedBirthdays = allBirthdays.filter(k => checkIsDead(k));
        let displayList = showDeceasedBirthday ? allBirthdays : livingBirthdays;
        section.style.display = 'block';
        if (allBirthdays.length === 0) {
            list.innerHTML = `<p style="font-size:0.9em; color:#888; width:100%; text-align:center;">${targetMonth}æœˆã«ãŠèª•ç”Ÿæ—¥ã®ã‚³ã‚¢ãƒ©ã¯è¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>`;
            return;
        }
        sortKoalasByLife(displayList).forEach(k => {
            const isDead = checkIsDead(k);
            const div = document.createElement('div');
            div.className = `birthday-card ${isDead ? 'deceased-style' : ''}`;
            div.innerHTML = `<div style="font-weight:bold; cursor:pointer;" onclick="jumpToKoala('${k.id}')">${k.name}${isDead ? ' (ğŸŒˆ)' : ''}</div><div style="font-size:0.8em; color:#666;">${k.zoo}</div><div style="color:#e65100; margin-top:5px;">ğŸ‚ ${k.birthday}</div><div style="font-size:0.8em; margin-top:3px;">${k.age}</div>`;
            list.appendChild(div);
        });
        if (displayList.length === 0 && !showDeceasedBirthday) {
            list.innerHTML += '<p style="font-size:0.9em; color:#888; width:100%;">ç¾åœ¨ã€åœ’ã§å…ƒæ°—ã«éã”ã—ã¦ã„ã‚‹ãŠèª•ç”Ÿæ—¥ã®å­ã¯ã„ã¾ã›ã‚“</p>';
        }
        if (deceasedBirthdays.length > 0) {
            const btn = document.createElement('button');
            btn.className = 'toggle-dead-btn';
            btn.textContent = showDeceasedBirthday ? 'âœ• ã„ã¾åœ’ã«ã„ã‚‹å­ã®ã¿è¡¨ç¤ºã«æˆ»ã™' : `ğŸŒˆ è™¹ã®ã‚€ã“ã†ã®å­ï¼ˆ${deceasedBirthdays.length}é ­ï¼‰ã‚‚è¡¨ç¤º`;
            btn.onclick = toggleBirthdayView;
            toggleContainer.appendChild(btn);
        }
    }

    function showRandomKoalas(totalCount) {
        const livingKoalas = koalaData.filter(k => !checkIsDead(k));
        const deceasedKoalas = koalaData.filter(k => checkIsDead(k));
        let selected = [];
        const shuffledLiving = [...livingKoalas].sort(() => 0.5 - Math.random());
        selected.push(...shuffledLiving.slice(0, 2));

        if (deceasedKoalas.length > 0) {
            const shuffledDeceased = [...deceasedKoalas].sort(() => 0.5 - Math.random());
            selected.push(shuffledDeceased[0]);
        } else if (shuffledLiving.length > 2) {
            selected.push(shuffledLiving[2]);
        }

        document.getElementById('listTitle').style.display = 'block';
        document.getElementById('listTitle').textContent = 'ğŸŒ¿ ä»Šæ—¥ã®ãŠã™ã™ã‚ã‚³ã‚¢ãƒ© ğŸŒ¿';
        renderKoalas(selected);
    }

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js').catch(err => console.log('SW failed', err));
        });
    }

    window.addEventListener('load', loadFromSpreadsheet);
</script>
</body>
</html>